 
 

 

 



 

 

 


<!DOCTYPE html>
<html lang="en">




    



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=5.0, minimum-scale=0.86">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <meta name='twitter:card'        content='summary' />
    <meta name='twitter:site'        content='@johnmroos'/>
    <meta name='twitter:creator'     content='@johnmroos'/>
    <meta name='twitter:title'       content='Deploy Azure Function App without downtime' />
    <meta name='twitter:description' content='Deploying a function app without downtime should be standard practice for anyone working with Azure Functions, but it does not come out of the box. It requires an understanding of how function apps gets configured, how deployment slots can help and why warmup does not necessarily mean your solution is up and running. In this post I will go through how this can be achieved using CD-pipelines in Azure DevOps.' />
    
    <meta name='twitter:domain'      content='https://blog.roostech.se/'/>
    

    <title>Deploy Azure Function App without downtime</title>
    <meta name="description" content="Deploying a function app without downtime should be standard practice for anyone working with Azure Functions, but it does not come out of the box. It requires an understanding of how function apps gets configured, how deployment slots can help and why warmup does not necessarily mean your solution is up and running. In this post I will go through how this can be achieved using CD-pipelines in Azure DevOps."/>
    
</head><body>
        
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCG3RSD" height="0" width="0" style="display:none;visibility:hidden"></iframe>
        
        <div class="container">
<input class="explorer-toggle" type="checkbox" id="explorer-toggle">
<label class="explorer-toggle-label" for="explorer-toggle"><div class="explorer-toggle-label-clickablearea"></div></label>

<div class="explorer-toggle-label-selection"></div>

<div class="left-menu-button-bar"></div>

<diV class='left-menu'>
    
    <ul class="root">
        <li class="root"><div class="menu-item folder open"><a class="menu-item-site" href="https://blog.roostech.se/">blog.roostech.se (HUGOVSCODE)</a></div>
            <ul>  
                <li><span class="menu-item folder open">content</span>
                    <ul>
                        <li><span class="menu-item folder open">posts</span>
                            <ul>
                                
                                <li ><a href="/posts/get-function-configuration-from-deployed-function-app/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get function configuration from deployed Function App.md</span></a></li>
                                
                                <li class="current"><a href="/posts/deploy-azure-function-app-without-downtime/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Deploy Azure Function App without downtime.md</span></a></li>
                                
                                <li ><a href="/posts/moving-from-blogger-to-github-pages-with-hugo/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Moving from Blogger to GitHub Pages using Hugo.md</span></a></li>
                                
                                <li ><a href="/posts/pester-5-discovery-and-testcases/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Pester 5: Discovery and TestCases.md</span></a></li>
                                
                                <li ><a href="/posts/create-and-use-azure-table-storage-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Create and use Azure Table storage with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use Edit-Command to discover the code behind built-in cmdlets.md</span></a></li>
                                
                                <li ><a href="/posts/invoke-restmethod-with-anti-forgery-tokens-in-header-and-cookie/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Invoke-RestMethod with anti-forgery tokens in header and cookie.md</span></a></li>
                                
                                <li ><a href="/posts/introducing-the-inimanager-module/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Introducing the IniManager module.md</span></a></li>
                                
                                <li ><a href="/posts/use-powershell-jobs-to-ping-many-from-many-with-log/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use PowerShell jobs to ping many from many with log.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-logo-made-with-css3/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">PowerShell logo made with CSS3.md</span></a></li>
                                
                                <li ><a href="/posts/what-is-this-here-string-people-are-talking-about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">What is this here-string people are talking about?.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-parameters-in-powershell-executes-before-you-know-it/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic parameters in PowerShell executes before you know it.md</span></a></li>
                                
                                <li ><a href="/posts/making-powershell-expressions-easier/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Making PowerShell expressions easier.md</span></a></li>
                                
                                <li ><a href="/posts/simple-select-from-database-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Simple select from database with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-use-splatting-in-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to use splatting in PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/get-imdbmovie-using-invoke-webrequest/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-IMDBmovie using Invoke-WebRequest.md</span></a></li>
                                
                                <li ><a href="/posts/classes-in-powershell-5.0/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Classes in Powershell 5.0.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-get-started-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to get started with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-find-hotfix-status/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Find hotfix status.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-write-object-to-sql/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Write object to SQL.md</span></a></li>
                                
                                <li ><a href="/posts/get-type-alternative-for-null-values/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-Type alternative for $null values.md</span></a></li>
                                
                                <li ><a href="/posts/compress-files-to-zip-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Compress files to Zip with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/enable-real-time-jmx-monitoring-in-cognos/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Enable real time JMX monitoring in Cognos.md</span></a></li>
                                
                                <li ><a href="/posts/move-data-or-log-files-for-tempdb-in-sql-server/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Move data or log files for TempDB in SQL Server.md</span></a></li>
                                
                                <li ><a href="/posts/resources-for-remotefx-in-windows-server-2012/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Resources for RemoteFX in Windows Server 2012.md</span></a></li>
                                
                                <li ><a href="/posts/rdp-8.0-for-windows-7-sp1/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">RDP 8.0 for Windows 7 SP1.md</span></a></li>
                                
                                <li ><a href="/posts/improving-remotefx-performance-in-hyper-v/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Improving RemoteFX performance in Hyper-V.md</span></a></li>
                                
                                <li ><a href="/posts/configure-remotefx-in-hyper-v-running-windows-server-2012-with-low-end-gpu/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Configure RemoteFX in Hyper-V running Windows Server 2012 with low end GPU.md</span></a></li>
                                
                                <li ><a href="/posts/sqlps-and-its-limitations/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">SQLPS and its limitations.md</span></a></li>
                                
                                <li ><a href="/posts/script-deployment-of-ssis-packages-from-folder/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Script deployment of SSIS packages from folder.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-deploy-of-ssrs-reports-using-rs.exe/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic deploy of SSRS reports using rs.exe.md</span></a></li>
                                
                                <li ><a href="/posts/remove-headers-in-excel-exports-to-fix-column-alignment/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Remove headers in Excel exports to fix column alignment.md</span></a></li>
                                
                                <li ><a href="/posts/using-executionlog2-for-statistics-and-monitoring/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Using ExecutionLog2 for statistics and monitoring.md</span></a></li>
                                
                            </ul>
                        </li>
                        <li><span class="menu-item folder open">pages</span>
                            <ul>
                                
                                <li ><a href="/about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">About me.md</span></a></li>
                                
                                <li ><a href="/chroma/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Chroma.md</span></a></li>
                                
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><span class="menu-item folder">data</span></li>
                <li><span class="menu-item folder">layouts</span></li>
                <li><span class="menu-item folder">resources</span></li>
                <li><span class="menu-item folder">static</span></li>
                <li><span class="menu-item folder open">themes</span>
                    <ul>
                        <li><span class="menu-item folder open">hugovscode</span>
                            <ul>
                                <li><a href="https://github.com/JohnRoos/HugoVSCode/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">.git</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>config.toml</li>
            </ul>
        </li>
    </ul>
  

    
</diV>
                <div class ="main-tabs">
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/">Home.md</a> 
                    </div>
                
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/get-function-configuration-from-deployed-function-app/">Get function configuration from deployed Function App.md</a>
                    </div>
                
                    <div class="main-tab current">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/deploy-azure-function-app-without-downtime/">Deploy Azure Function App without downtime.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/moving-from-blogger-to-github-pages-with-hugo/">Moving from Blogger to GitHub Pages using Hugo.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/pester-5-discovery-and-testcases/">Pester 5: Discovery and TestCases.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/create-and-use-azure-table-storage-with-powershell/">Create and use Azure Table storage with PowerShell.md</a>
                    </div>
                
                </div>
            
            
            <div class='main'>
    <div class="main-path">
        <span><a class="path-link" href="https://blog.roostech.se/">blog.roostech.se</a></span><span class="folder">content</span><span class="folder">posts</span><span class="folder">Deploy Azure Function App without downtime.md</span>
        
                
                
                <span class="postdate-container">&nbsp;(<time class="postdate" datetime="2020-10-29">October 29, 2020</time>)</span>
            
    </div>
    
    <div class="main-content-toggle">

        
        <input class="source-preview-split" type="checkbox" id="source-preview-split-toggle">
        <label class="source-preview-split-label" for="source-preview-split-toggle"></label>

        <input class="source-toggle" type="checkbox" id="source-toggle">
        <label class="source-toggle-label" for="source-toggle"></label>

        <div class="main-content">
            ---<br />
            <span class="md-frontmatter">title</span>: <span class="md-frontmatter-string">Deploy Azure Function App without downtime</span><br />
            <span class="md-frontmatter">date</span>: 2020-10-29 21:53:00 &#43;0200 &#43;0200<br />
            <span class="md-frontmatter">draft</span>: <span class="md-frontmatter">false</span><br />
            <span class="md-frontmatter">author</span>: <span class="md-frontmatter-string">John</span><br />
            ----
            <p>Deploying a function app without downtime should be standard practice for anyone working with Azure Functions, but it does not come out of the box. It requires an understanding of how function apps gets configured, how deployment slots can help and why warmup does not necessarily mean your solution is up and running. In this post I will go through how this can be achieved using CD-pipelines in Azure DevOps.</p>
<h2 id="defining-the-problem">Defining the problem</h2>
<p>First we need to set the stage. What is the problem we are trying to solve? Imagine you have a Function App running PowerShell. In this app you might have a profile.ps1 containing quite a lot of code which need to be processed during a cold start. Or you might need to import large modules which causes all functions to wait until the modules are loaded. After deploying a new version you will experience slow response times or even timeouts while the profile or modules are loading. You want to be able to seamlessly deploy new versions of the app using a continuous deployment mindset without users ever noticing.</p>
<h3 id="what-you-need">What you need</h3>
<p>To be able solve this problem using the examples in this post there are a few things you need.</p>
<ul>
<li>Possibility to create a Function App with Standard, Premium, or Isolated App Service plan tier. Deployment slots are <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits#app-service-limits">not for free</a>.</li>
<li>Possibility to run Azure DevOps Pipelines for deployment.</li>
<li>Az PowerShell module</li>
<li>Basic knowledge about PowerShell, YAML, Azure Function Apps and Azure DevOps</li>
</ul>
<h2 id="create-the-function-app-in-azure">Create the function app in Azure</h2>
<p>Later in this post we are going to use Deployment Slots which requires Standard, Premium, or Isolated App Service plan tier. In this example I have selected EP1. Change the variables to your liking before running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Create Function App</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Location</span>           <span class="p">=</span> <span class="s1">&#39;North Europe&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ResourceGroupName</span>  <span class="p">=</span> <span class="s2">&#34;myresourcegroup&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$StorageAccountName</span> <span class="p">=</span> <span class="s2">&#34;mystorageaccount&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionPlanName</span>   <span class="p">=</span> <span class="s2">&#34;myfunctionplan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionAppName</span>    <span class="p">=</span> <span class="s2">&#34;myfunction&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create resource group</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzResourceGroup</span> <span class="n">-Name</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                    <span class="n">-Location</span> <span class="nv">$Location</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-SkuName</span> <span class="s1">&#39;Standard_LRS&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app plan</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionAppPlan</span> <span class="n">-Name</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Sku</span> <span class="s1">&#39;EP1&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-WorkerType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionApp</span> <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-StorageAccountName</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-Runtime</span> <span class="s1">&#39;PowerShell&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-RuntimeVersion</span> <span class="s1">&#39;7.0&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-PlanName</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-FunctionsVersion</span> <span class="s1">&#39;3&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-OSType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span></code></pre></div><p>Since the function app is running on EP1, don&rsquo;t forget to remove it when you are done. It costs even when you are not using it and even when its turned off.</p>
<h2 id="function-app-code">Function app code</h2>
<p>For this scenario I have created a very simple Function App. It contains one HTTP triggered function and a modified profile.</p>
<h3 id="status-endpoint">Status endpoint</h3>
<p>When this function (or any function) is triggered the profile will run before the endpoint starts to execute. The status endpoint returns a predefined string. I will update this string during every example to show the difference when a new version is deployed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># status\run.ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">using</span> <span class="n">namespace</span> <span class="n">System</span><span class="p">.</span><span class="py">Net</span>
</span></span><span class="line"><span class="cl"><span class="k">param</span><span class="p">(</span><span class="nv">$Request</span><span class="p">,</span> <span class="nv">$TriggerMetadata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$body</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Message</span> <span class="p">=</span> <span class="s2">&#34;Hi, I&#39;m running version 1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">Push-OutputBinding</span> <span class="n">-Name</span> <span class="n">Response</span> <span class="n">-Value</span> <span class="p">([</span><span class="no">HttpResponseContext</span><span class="p">]</span><span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">StatusCode</span> <span class="p">=</span> <span class="p">[</span><span class="no">HttpStatusCode</span><span class="p">]::</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">    <span class="n">Body</span> <span class="p">=</span> <span class="nv">$body</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h3 id="profile">Profile</h3>
<p>I removed everything in the default profile.ps1 and replaced it with Start-Sleep to simulate anything that might take a long time to load.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># profile.ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">30</span>
</span></span></code></pre></div><p>That&rsquo;s the whole app. One HTTP triggered function and a slow profile.</p>
<h2 id="deployment-from-vscode">Deployment from VSCode</h2>
<p>To get things started, lets do the first deploy from VSCode. Deploy using the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions">Azure Functions</a> extension. If you haven&rsquo;t used this extension, I highly recommend it. It has a lot of really nice features for working with Azure Functions. I will not describe how to create and deploy an Azure Function App in this post. If you haven&rsquo;t deployed a function app before, you can follow <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-vs-code?pivots=programming-language-powershell">this guide</a>.</p>
<h2 id="verification-script">Verification script</h2>
<p>To be able to test that the endpoint we just deployed works during deployments, I wrote this short script which will simply call the status endpoint in a loop until canceled. During every deployment we will have this script running to monitor for timeouts. In the end we want this script to return a good response every few seconds during a deployment, without warnings, until the new version of the app is up and running. Run the script now to make sure your newly deployed app is working. Change the <strong>$uri</strong> variable to the Uri for your function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Verification.ps1</span>
</span></span><span class="line"><span class="cl"><span class="nv">$uri</span> <span class="p">=</span> <span class="s1">&#39;https://myfunction.azurewebsites.net/api/status&#39;</span> <span class="c"># Uri to status function</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="vm">$true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="nv">$uri</span> <span class="n">-TimeoutSec</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Output</span> <span class="nv">$response</span><span class="p">.</span><span class="py">message</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Warning</span> <span class="s1">&#39;No response&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If everything has worked as expected, you should first see a few timeouts and then it should start responding. This is because we put Start-Sleep in the profile.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Before every deployment in this post, I will change the version number on the status function to make sure this script shows the change during deployment.</p>
<h2 id="standard-cd-deployment">Standard CD deployment</h2>
<p>Now we have the first version deployed. What happens if we try to deploy a new version using a Continuous Deployment (CD) pipeline? We can keep the verification script running during the deploy to see what happens. In this scenario we will do a regular Function App deployment from Azure DevOps.</p>
<h3 id="deploy-with-azure-devops-pipeline">Deploy with Azure DevOps pipeline</h3>
<p>Below you can see the YAML which can be used in a Azure DevOps pipeline. We don&rsquo;t really care about the Build stage for this scenario, but its included for completeness. Change the variables in the top to suit your environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">ArchiveFiles@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Archive files&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">rootFolderOrFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(workingDirectory)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">includeRootFolder</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveType</span><span class="p">:</span><span class="w"> </span><span class="l">zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replaceExistingArchive</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">publish</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">artifact</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="verification">Verification</h3>
<p>To test how this will affect uptime, first start the verification script above. Change the version in the status function to version 2. Push the changes to trigger a deploy. During deployment the verification script should return something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>This is not what we want. During deployment the app restarted. After the restart it imported modules if there were any in the requirements file (not used in this example). When the status function was triggered by the verification script, profile.ps1 executed. When profile.ps1 was done executing, the status function could start to run its code.</p>
<p>This resulted in a few timeouts and the uptime was affected. We should be able to solve this using Deployment Slots.</p>
<h2 id="deployment-slots">Deployment slots</h2>
<p>Imagine your app is running on a web server, like IIS. Your app is just a website on that server. If you add another slot, that would be the same as adding another website. The new website has its own URL and settings. If you at any time would like to switch between these websites you can simply change the binding to make the new site use the old sites URL. This is fairly close to how deployment slots work.</p>
<p>Note that deployment slots share processors, so if you put heavy load on one slot it will affect the others.</p>
<h3 id="slot-swap">Slot swap</h3>
<p>You can use deployment slots to deploy new versions of your app, test that the new version is working as expected, and then swap them to avoid downtime. If you then notice that something is not working as expected you can swap back to the previous slot which has the old version.</p>
<h3 id="the-different-stages-of-a-slot-swap">The different stages of a slot swap</h3>
<p>There are a few things that happens behind the scenes during a slot swap. Here is a simplified version of the process:</p>
<ol>
<li>Apply app settings from target slot to source slot. (triggers a restart)</li>
<li>Wait for source slot to restart.</li>
<li>Trigger local cache initialization, if needed.</li>
<li>Trigger application initiation, if needed</li>
<li>Wait for source slot to warm up</li>
<li>Swap slots by switching the routing rules (can trigger a restart)</li>
</ol>
<p>More detailed information about these stages can be found <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#what-happens-during-a-swap">here</a>.</p>
<h3 id="add-a-new-slot-to-the-function-app">Add a new slot to the function app</h3>
<p>To add a new slot to a function app, run the following command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Add staging slot</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Slot</span> <span class="s1">&#39;staging&#39;</span>
</span></span></code></pre></div><p>I used the name &ldquo;staging&rdquo;, but you can use any name you want.</p>
<h3 id="deploy-to-slot-with-azure-devops-pipeline">Deploy to slot with Azure DevOps pipeline</h3>
<p>Now its time to see if a Slot swap could help us get closer to the &ldquo;no downtime&rdquo; goal. First we need to set the name of the slot we want to deploy to. In this scenario I have named it &ldquo;staging&rdquo; and I added it as a variable. The second part we need to do is to tell the deployment to deploy to a slot (deployToSlotOrASE is set to true) and then give it the name of the slot, using the variable.</p>
<p>When the deploy stage is configured, we need to add the slot swap configuration. I like to add that as a separate stage to make it easier to read both in the YAML and later in Azure DevOps. The &ldquo;Swap slots&rdquo; need to know which slot it should swap with production. We use the variable here again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>Now we have three stages in the pipeline. One for building the artifact, one for deploying the artifact and one for swapping slots. That should do it, right?</p>
<h3 id="slot-swap-result">Slot swap result</h3>
<p>Change the version in the status function to version 3, run the verification script, push the changes to master. After a while you should get something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>We still get downtime. Didn&rsquo;t Microsoft say that swapping slots would be the solution to our problem? Well, its one part of the solution. When you deploy a new version of the app on the staging slot, the app on the staging slot will restart. After the restart it will wait for the app to warm up. However, profile.ps1 is not part of the warmup process so when we call the status endpoint, it has to run profile.ps1 before executing its own code and return a response.</p>
<h2 id="deployment-slots-with-post-warmup-script-before-slot-swap">Deployment slots with post-warmup script before slot swap</h2>
<p>So if the profile.ps1 is not part of the warmup we need to have a way of executing it before we do the swap. We can do this by writing a small script which will be included in the YAML and executed before the slot swap. The script will attempt to call the HTTP triggered function until it responds. When it finally responds we know that the profile has executed. In the YAML we add a PowerShell task with an inline script, before the swap. The URL for the source slot endpoint has been added as a variable as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>The inline script could also output status messages to the console to make it easier to follow in the log, but I haven&rsquo;t included that here.</p>
<h3 id="verification-1">Verification</h3>
<p>When the above YAML code has been saved, update the version in the status endpoint to version 4, push it to master, and start the verification script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>This still doesn&rsquo;t look good. Why is that? If you scroll back up to where I wrote about <a href="#the-different-stages-of-a-slot-swap">the different stages of a slot swap</a> you can see that the first thing a slot swap does is to apply settings from the production slot to the staging slot. This triggers a restart. So we need to have a way to run the inline script after the settings have been applied and the app has restarted.</p>
<h2 id="deployment-slots-with-preview-and-post-warmup-script">Deployment slots with preview and post-warmup script</h2>
<p>You can have some control over how a slot swap is done. There is a feature called &ldquo;Swap with preview&rdquo; or &ldquo;Multi-phase swap&rdquo; which starts the swapping process, but does not complete it. Swap with preview will begin a swap operation, but will stop after the first stage (copying settings etc.). You can then do whatever you need to the app before completing the swap. Here is a good opportunity for us to add our post-warmup script.</p>
<p>During the Slot Swap stage, we first run a &lsquo;Start Swap With Preview&rsquo; action, then we execute the script which will trigger the status function (and profile.ps1). Finally we complete the swap operation by doing a &lsquo;Swap Slots&rsquo; action.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Complete Slot Swap&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><h3 id="verify-result">Verify result</h3>
<p>Just as before we change the version in the status function to version 5, push to master and start the verification script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>You would think that this should work, but there is a small detail that is easily missed. This detail has nothing to do with the PowerShell script or the YAML code. It has to do with the last step in the slot swap process. On the last step of a swap, the swap is completed by changing the routing rules. Could that trigger another restart?</p>
<h2 id="deployment-slots-with-preview-post-warmup-script-and-app-config">Deployment slots with preview, post-warmup script and app config</h2>
<p>Often, the app will restart one last time after the swap has completed (and sporadically after that) because the hostname binding goes out of sync. This is how Microsoft explains it:</p>
<blockquote>
<p>This is because after a swap, the hostname binding configuration goes out of sync, which by itself doesn&rsquo;t cause restarts. However, certain underlying storage events (such as storage volume failovers) may detect these discrepancies and force all worker processes to restart.</p>
</blockquote>
<p>This can be solved by adding the setting WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG on both slots. Read more about this setting <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#troubleshoot-swaps">here</a>. There is really no downside to adding this setting for a Function App running PowerShell, as you can read <a href="https://github.com/projectkudu/kudu/wiki/Configurable-settings#disable-the-generation-of-bindings-in-applicationhostconfig">here</a>.</p>
<h2 id="add-app-setting">Add app setting</h2>
<p>You can use the PowerShell cmdlet Set-AzWebAppSlot to set app configurations. But be careful. This cmdlet requires you to give it ALL the settings the app should have. If you only give it the settings you want to add, all previous settings will be removed. Because of that I wrote a script which first picks up all the existing settings, then adds the new setting to the list before giving it to Set-AzWebAppSlot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Add app setting</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Slot</span> <span class="k">in</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$WebAppSlot</span> <span class="p">=</span> <span class="nb">Get-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Setting</span> <span class="k">in</span> <span class="nv">$WebAppSlot</span><span class="p">.</span><span class="py">SiteConfig</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="nv">$Setting</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="nv">$Setting</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="s1">&#39;WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">Set-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-AppSettings</span> <span class="nv">$AppSettings</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Changing settings will trigger a restart of the app. Use the verification script to get it up and running again.</p>
<h3 id="deploy-and-verify-again">Deploy and verify again</h3>
<p>Change the version in the status endpoint one more time (version 6). Start the verification script and push the change to master. If this doesn&rsquo;t work, I will go mad.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>No downtime! We have finally reach the goal. After all this work we can finally deploy new versions seamlessly.</p>
<h2 id="summary">Summary</h2>
<p>To be able to deploy a PowerShell Function App without any downtime you need to keep a few things in mind.</p>
<ol>
<li>Use Slot swap with preview</li>
<li>Add a post-warmup script to trigger the profile</li>
<li>Add the setting WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG=1 to both slots</li>
</ol>
<p>Here is the complete script to create the app, add a slot and configure the app setting.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Create Function App</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Location</span>           <span class="p">=</span> <span class="s1">&#39;North Europe&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ResourceGroupName</span>  <span class="p">=</span> <span class="s2">&#34;myresourcegroup&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$StorageAccountName</span> <span class="p">=</span> <span class="s2">&#34;mystorageaccount&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionPlanName</span>   <span class="p">=</span> <span class="s2">&#34;myfunctionplan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionAppName</span>    <span class="p">=</span> <span class="s2">&#34;myfunction&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create resource group</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzResourceGroup</span> <span class="n">-Name</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                    <span class="n">-Location</span> <span class="nv">$Location</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-SkuName</span> <span class="s1">&#39;Standard_LRS&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app plan</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionAppPlan</span> <span class="n">-Name</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Sku</span> <span class="s1">&#39;EP1&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-WorkerType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionApp</span> <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-StorageAccountName</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-Runtime</span> <span class="s1">&#39;PowerShell&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-RuntimeVersion</span> <span class="s1">&#39;7.0&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-PlanName</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-FunctionsVersion</span> <span class="s1">&#39;3&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-OSType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Add staging slot</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Slot</span> <span class="s1">&#39;staging&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Add app setting</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Slot</span> <span class="k">in</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$WebAppSlot</span> <span class="p">=</span> <span class="nb">Get-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Setting</span> <span class="k">in</span> <span class="nv">$WebAppSlot</span><span class="p">.</span><span class="py">SiteConfig</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="nv">$Setting</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="nv">$Setting</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="s1">&#39;WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">Set-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-AppSettings</span> <span class="nv">$AppSettings</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here is the complete YAML, including the build step.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">ArchiveFiles@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Archive files&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">rootFolderOrFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(workingDirectory)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">includeRootFolder</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveType</span><span class="p">:</span><span class="w"> </span><span class="l">zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replaceExistingArchive</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">publish</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">artifact</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Complete Slot Swap&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>Deployment slots are great to use when doing CI/CD pipelines as long as you understand how it works. It took me a while to figure all this out so I hope you find this post helpful.</p>

        </div>

        
        <div class="main-content-preview">
            <h1>Deploy Azure Function App without downtime</h1>
            
            <p>Deploying a function app without downtime should be standard practice for anyone working with Azure Functions, but it does not come out of the box. It requires an understanding of how function apps gets configured, how deployment slots can help and why warmup does not necessarily mean your solution is up and running. In this post I will go through how this can be achieved using CD-pipelines in Azure DevOps.</p>
<h2 id="defining-the-problem">Defining the problem</h2>
<p>First we need to set the stage. What is the problem we are trying to solve? Imagine you have a Function App running PowerShell. In this app you might have a profile.ps1 containing quite a lot of code which need to be processed during a cold start. Or you might need to import large modules which causes all functions to wait until the modules are loaded. After deploying a new version you will experience slow response times or even timeouts while the profile or modules are loading. You want to be able to seamlessly deploy new versions of the app using a continuous deployment mindset without users ever noticing.</p>
<h3 id="what-you-need">What you need</h3>
<p>To be able solve this problem using the examples in this post there are a few things you need.</p>
<ul>
<li>Possibility to create a Function App with Standard, Premium, or Isolated App Service plan tier. Deployment slots are <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/azure-subscription-service-limits#app-service-limits">not for free</a>.</li>
<li>Possibility to run Azure DevOps Pipelines for deployment.</li>
<li>Az PowerShell module</li>
<li>Basic knowledge about PowerShell, YAML, Azure Function Apps and Azure DevOps</li>
</ul>
<h2 id="create-the-function-app-in-azure">Create the function app in Azure</h2>
<p>Later in this post we are going to use Deployment Slots which requires Standard, Premium, or Isolated App Service plan tier. In this example I have selected EP1. Change the variables to your liking before running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Create Function App</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Location</span>           <span class="p">=</span> <span class="s1">&#39;North Europe&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ResourceGroupName</span>  <span class="p">=</span> <span class="s2">&#34;myresourcegroup&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$StorageAccountName</span> <span class="p">=</span> <span class="s2">&#34;mystorageaccount&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionPlanName</span>   <span class="p">=</span> <span class="s2">&#34;myfunctionplan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionAppName</span>    <span class="p">=</span> <span class="s2">&#34;myfunction&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create resource group</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzResourceGroup</span> <span class="n">-Name</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                    <span class="n">-Location</span> <span class="nv">$Location</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-SkuName</span> <span class="s1">&#39;Standard_LRS&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app plan</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionAppPlan</span> <span class="n">-Name</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Sku</span> <span class="s1">&#39;EP1&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-WorkerType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionApp</span> <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-StorageAccountName</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-Runtime</span> <span class="s1">&#39;PowerShell&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-RuntimeVersion</span> <span class="s1">&#39;7.0&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-PlanName</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-FunctionsVersion</span> <span class="s1">&#39;3&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-OSType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span></code></pre></div><p>Since the function app is running on EP1, don&rsquo;t forget to remove it when you are done. It costs even when you are not using it and even when its turned off.</p>
<h2 id="function-app-code">Function app code</h2>
<p>For this scenario I have created a very simple Function App. It contains one HTTP triggered function and a modified profile.</p>
<h3 id="status-endpoint">Status endpoint</h3>
<p>When this function (or any function) is triggered the profile will run before the endpoint starts to execute. The status endpoint returns a predefined string. I will update this string during every example to show the difference when a new version is deployed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># status\run.ps1</span>
</span></span><span class="line"><span class="cl"><span class="n">using</span> <span class="n">namespace</span> <span class="n">System</span><span class="p">.</span><span class="py">Net</span>
</span></span><span class="line"><span class="cl"><span class="k">param</span><span class="p">(</span><span class="nv">$Request</span><span class="p">,</span> <span class="nv">$TriggerMetadata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$body</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Message</span> <span class="p">=</span> <span class="s2">&#34;Hi, I&#39;m running version 1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">Push-OutputBinding</span> <span class="n">-Name</span> <span class="n">Response</span> <span class="n">-Value</span> <span class="p">([</span><span class="no">HttpResponseContext</span><span class="p">]</span><span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">StatusCode</span> <span class="p">=</span> <span class="p">[</span><span class="no">HttpStatusCode</span><span class="p">]::</span><span class="n">OK</span>
</span></span><span class="line"><span class="cl">    <span class="n">Body</span> <span class="p">=</span> <span class="nv">$body</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h3 id="profile">Profile</h3>
<p>I removed everything in the default profile.ps1 and replaced it with Start-Sleep to simulate anything that might take a long time to load.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># profile.ps1</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">30</span>
</span></span></code></pre></div><p>That&rsquo;s the whole app. One HTTP triggered function and a slow profile.</p>
<h2 id="deployment-from-vscode">Deployment from VSCode</h2>
<p>To get things started, lets do the first deploy from VSCode. Deploy using the <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions">Azure Functions</a> extension. If you haven&rsquo;t used this extension, I highly recommend it. It has a lot of really nice features for working with Azure Functions. I will not describe how to create and deploy an Azure Function App in this post. If you haven&rsquo;t deployed a function app before, you can follow <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-vs-code?pivots=programming-language-powershell">this guide</a>.</p>
<h2 id="verification-script">Verification script</h2>
<p>To be able to test that the endpoint we just deployed works during deployments, I wrote this short script which will simply call the status endpoint in a loop until canceled. During every deployment we will have this script running to monitor for timeouts. In the end we want this script to return a good response every few seconds during a deployment, without warnings, until the new version of the app is up and running. Run the script now to make sure your newly deployed app is working. Change the <strong>$uri</strong> variable to the Uri for your function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Verification.ps1</span>
</span></span><span class="line"><span class="cl"><span class="nv">$uri</span> <span class="p">=</span> <span class="s1">&#39;https://myfunction.azurewebsites.net/api/status&#39;</span> <span class="c"># Uri to status function</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="vm">$true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$response</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="n">-Uri</span> <span class="nv">$uri</span> <span class="n">-TimeoutSec</span> <span class="mf">10</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Output</span> <span class="nv">$response</span><span class="p">.</span><span class="py">message</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Warning</span> <span class="s1">&#39;No response&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If everything has worked as expected, you should first see a few timeouts and then it should start responding. This is because we put Start-Sleep in the profile.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Before every deployment in this post, I will change the version number on the status function to make sure this script shows the change during deployment.</p>
<h2 id="standard-cd-deployment">Standard CD deployment</h2>
<p>Now we have the first version deployed. What happens if we try to deploy a new version using a Continuous Deployment (CD) pipeline? We can keep the verification script running during the deploy to see what happens. In this scenario we will do a regular Function App deployment from Azure DevOps.</p>
<h3 id="deploy-with-azure-devops-pipeline">Deploy with Azure DevOps pipeline</h3>
<p>Below you can see the YAML which can be used in a Azure DevOps pipeline. We don&rsquo;t really care about the Build stage for this scenario, but its included for completeness. Change the variables in the top to suit your environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">ArchiveFiles@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Archive files&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">rootFolderOrFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(workingDirectory)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">includeRootFolder</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveType</span><span class="p">:</span><span class="w"> </span><span class="l">zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replaceExistingArchive</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">publish</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">artifact</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="verification">Verification</h3>
<p>To test how this will affect uptime, first start the verification script above. Change the version in the status function to version 2. Push the changes to trigger a deploy. During deployment the verification script should return something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 1!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>This is not what we want. During deployment the app restarted. After the restart it imported modules if there were any in the requirements file (not used in this example). When the status function was triggered by the verification script, profile.ps1 executed. When profile.ps1 was done executing, the status function could start to run its code.</p>
<p>This resulted in a few timeouts and the uptime was affected. We should be able to solve this using Deployment Slots.</p>
<h2 id="deployment-slots">Deployment slots</h2>
<p>Imagine your app is running on a web server, like IIS. Your app is just a website on that server. If you add another slot, that would be the same as adding another website. The new website has its own URL and settings. If you at any time would like to switch between these websites you can simply change the binding to make the new site use the old sites URL. This is fairly close to how deployment slots work.</p>
<p>Note that deployment slots share processors, so if you put heavy load on one slot it will affect the others.</p>
<h3 id="slot-swap">Slot swap</h3>
<p>You can use deployment slots to deploy new versions of your app, test that the new version is working as expected, and then swap them to avoid downtime. If you then notice that something is not working as expected you can swap back to the previous slot which has the old version.</p>
<h3 id="the-different-stages-of-a-slot-swap">The different stages of a slot swap</h3>
<p>There are a few things that happens behind the scenes during a slot swap. Here is a simplified version of the process:</p>
<ol>
<li>Apply app settings from target slot to source slot. (triggers a restart)</li>
<li>Wait for source slot to restart.</li>
<li>Trigger local cache initialization, if needed.</li>
<li>Trigger application initiation, if needed</li>
<li>Wait for source slot to warm up</li>
<li>Swap slots by switching the routing rules (can trigger a restart)</li>
</ol>
<p>More detailed information about these stages can be found <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#what-happens-during-a-swap">here</a>.</p>
<h3 id="add-a-new-slot-to-the-function-app">Add a new slot to the function app</h3>
<p>To add a new slot to a function app, run the following command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Add staging slot</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Slot</span> <span class="s1">&#39;staging&#39;</span>
</span></span></code></pre></div><p>I used the name &ldquo;staging&rdquo;, but you can use any name you want.</p>
<h3 id="deploy-to-slot-with-azure-devops-pipeline">Deploy to slot with Azure DevOps pipeline</h3>
<p>Now its time to see if a Slot swap could help us get closer to the &ldquo;no downtime&rdquo; goal. First we need to set the name of the slot we want to deploy to. In this scenario I have named it &ldquo;staging&rdquo; and I added it as a variable. The second part we need to do is to tell the deployment to deploy to a slot (deployToSlotOrASE is set to true) and then give it the name of the slot, using the variable.</p>
<p>When the deploy stage is configured, we need to add the slot swap configuration. I like to add that as a separate stage to make it easier to read both in the YAML and later in Azure DevOps. The &ldquo;Swap slots&rdquo; need to know which slot it should swap with production. We use the variable here again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>Now we have three stages in the pipeline. One for building the artifact, one for deploying the artifact and one for swapping slots. That should do it, right?</p>
<h3 id="slot-swap-result">Slot swap result</h3>
<p>Change the version in the status function to version 3, run the verification script, push the changes to master. After a while you should get something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 2!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>We still get downtime. Didn&rsquo;t Microsoft say that swapping slots would be the solution to our problem? Well, its one part of the solution. When you deploy a new version of the app on the staging slot, the app on the staging slot will restart. After the restart it will wait for the app to warm up. However, profile.ps1 is not part of the warmup process so when we call the status endpoint, it has to run profile.ps1 before executing its own code and return a response.</p>
<h2 id="deployment-slots-with-post-warmup-script-before-slot-swap">Deployment slots with post-warmup script before slot swap</h2>
<p>So if the profile.ps1 is not part of the warmup we need to have a way of executing it before we do the swap. We can do this by writing a small script which will be included in the YAML and executed before the slot swap. The script will attempt to call the HTTP triggered function until it responds. When it finally responds we know that the profile has executed. In the YAML we add a PowerShell task with an inline script, before the swap. The URL for the source slot endpoint has been added as a variable as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>The inline script could also output status messages to the console to make it easier to follow in the log, but I haven&rsquo;t included that here.</p>
<h3 id="verification-1">Verification</h3>
<p>When the above YAML code has been saved, update the version in the status endpoint to version 4, push it to master, and start the verification script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 3!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>This still doesn&rsquo;t look good. Why is that? If you scroll back up to where I wrote about <a href="#the-different-stages-of-a-slot-swap">the different stages of a slot swap</a> you can see that the first thing a slot swap does is to apply settings from the production slot to the staging slot. This triggers a restart. So we need to have a way to run the inline script after the settings have been applied and the app has restarted.</p>
<h2 id="deployment-slots-with-preview-and-post-warmup-script">Deployment slots with preview and post-warmup script</h2>
<p>You can have some control over how a slot swap is done. There is a feature called &ldquo;Swap with preview&rdquo; or &ldquo;Multi-phase swap&rdquo; which starts the swapping process, but does not complete it. Swap with preview will begin a swap operation, but will stop after the first stage (copying settings etc.). You can then do whatever you need to the app before completing the swap. Here is a good opportunity for us to add our post-warmup script.</p>
<p>During the Slot Swap stage, we first run a &lsquo;Start Swap With Preview&rsquo; action, then we execute the script which will trigger the status function (and profile.ps1). Finally we complete the swap operation by doing a &lsquo;Swap Slots&rsquo; action.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Build stage omitted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Complete Slot Swap&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><h3 id="verify-result">Verify result</h3>
<p>Just as before we change the version in the status function to version 5, push to master and start the verification script.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 4!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">WARNING: No response
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>You would think that this should work, but there is a small detail that is easily missed. This detail has nothing to do with the PowerShell script or the YAML code. It has to do with the last step in the slot swap process. On the last step of a swap, the swap is completed by changing the routing rules. Could that trigger another restart?</p>
<h2 id="deployment-slots-with-preview-post-warmup-script-and-app-config">Deployment slots with preview, post-warmup script and app config</h2>
<p>Often, the app will restart one last time after the swap has completed (and sporadically after that) because the hostname binding goes out of sync. This is how Microsoft explains it:</p>
<blockquote>
<p>This is because after a swap, the hostname binding configuration goes out of sync, which by itself doesn&rsquo;t cause restarts. However, certain underlying storage events (such as storage volume failovers) may detect these discrepancies and force all worker processes to restart.</p>
</blockquote>
<p>This can be solved by adding the setting WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG on both slots. Read more about this setting <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots#troubleshoot-swaps">here</a>. There is really no downside to adding this setting for a Function App running PowerShell, as you can read <a href="https://github.com/projectkudu/kudu/wiki/Configurable-settings#disable-the-generation-of-bindings-in-applicationhostconfig">here</a>.</p>
<h2 id="add-app-setting">Add app setting</h2>
<p>You can use the PowerShell cmdlet Set-AzWebAppSlot to set app configurations. But be careful. This cmdlet requires you to give it ALL the settings the app should have. If you only give it the settings you want to add, all previous settings will be removed. Because of that I wrote a script which first picks up all the existing settings, then adds the new setting to the list before giving it to Set-AzWebAppSlot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Add app setting</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Slot</span> <span class="k">in</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$WebAppSlot</span> <span class="p">=</span> <span class="nb">Get-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Setting</span> <span class="k">in</span> <span class="nv">$WebAppSlot</span><span class="p">.</span><span class="py">SiteConfig</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="nv">$Setting</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="nv">$Setting</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="s1">&#39;WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">Set-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-AppSettings</span> <span class="nv">$AppSettings</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Changing settings will trigger a restart of the app. Use the verification script to get it up and running again.</p>
<h3 id="deploy-and-verify-again">Deploy and verify again</h3>
<p>Change the version in the status endpoint one more time (version 6). Start the verification script and push the change to master. If this doesn&rsquo;t work, I will go mad.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 5!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">Hi, I&#39;m running version 6!
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>No downtime! We have finally reach the goal. After all this work we can finally deploy new versions seamlessly.</p>
<h2 id="summary">Summary</h2>
<p>To be able to deploy a PowerShell Function App without any downtime you need to keep a few things in mind.</p>
<ol>
<li>Use Slot swap with preview</li>
<li>Add a post-warmup script to trigger the profile</li>
<li>Add the setting WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG=1 to both slots</li>
</ol>
<p>Here is the complete script to create the app, add a slot and configure the app setting.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Create Function App</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$Location</span>           <span class="p">=</span> <span class="s1">&#39;North Europe&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ResourceGroupName</span>  <span class="p">=</span> <span class="s2">&#34;myresourcegroup&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$StorageAccountName</span> <span class="p">=</span> <span class="s2">&#34;mystorageaccount&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionPlanName</span>   <span class="p">=</span> <span class="s2">&#34;myfunctionplan&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$FunctionAppName</span>    <span class="p">=</span> <span class="s2">&#34;myfunction&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create resource group</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzResourceGroup</span> <span class="n">-Name</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                    <span class="n">-Location</span> <span class="nv">$Location</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-SkuName</span> <span class="s1">&#39;Standard_LRS&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app plan</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionAppPlan</span> <span class="n">-Name</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Location</span> <span class="nv">$Location</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-Sku</span> <span class="s1">&#39;EP1&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                      <span class="n">-WorkerType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Create function app</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzFunctionApp</span> <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-StorageAccountName</span> <span class="nv">$StorageAccountName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-Runtime</span> <span class="s1">&#39;PowerShell&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-RuntimeVersion</span> <span class="s1">&#39;7.0&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-PlanName</span> <span class="nv">$FunctionPlanName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-FunctionsVersion</span> <span class="s1">&#39;3&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                  <span class="n">-OSType</span> <span class="s1">&#39;Windows&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Add staging slot</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                 <span class="n">-Slot</span> <span class="s1">&#39;staging&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Add app setting</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$Slot</span> <span class="k">in</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="s1">&#39;staging&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$WebAppSlot</span> <span class="p">=</span> <span class="nb">Get-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$Setting</span> <span class="k">in</span> <span class="nv">$WebAppSlot</span><span class="p">.</span><span class="py">SiteConfig</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="nv">$Setting</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="nv">$Setting</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$AppSettings</span><span class="p">.</span><span class="py">Add</span><span class="p">(</span><span class="s1">&#39;WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">Set-AzWebAppSlot</span> <span class="n">-ResourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Name</span> <span class="nv">$FunctionAppName</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-AppSettings</span> <span class="nv">$AppSettings</span> <span class="p">`</span>
</span></span><span class="line"><span class="cl">                     <span class="n">-Slot</span> <span class="nv">$Slot</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here is the complete YAML, including the build step.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">trigger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Azure Resource Manager connection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Name of your Azure RM connection&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Function app name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">functionAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myfunction&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Agent VM image name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmImageName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;vs2017-win2016&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Working Directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workingDirectory</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(System.DefaultWorkingDirectory)/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Resource Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceGroup</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;myresourcegroup&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sourceSlot</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Source Slot endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">statusEndpointUri</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://myfunction-staging.azurewebsites.net/api/status&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">ArchiveFiles@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Archive files&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">rootFolderOrFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(workingDirectory)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">includeRootFolder</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveType</span><span class="p">:</span><span class="w"> </span><span class="l">zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">archiveFile</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">replaceExistingArchive</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">publish</span><span class="p">:</span><span class="w"> </span><span class="l">$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">artifact</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Publish artifact&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">vmImage</span><span class="p">:</span><span class="w"> </span><span class="l">$(vmImageName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureFunctionApp@1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Azure functions app deploy&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">functionApp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">appName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">package</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(Pipeline.Workspace)/drop/$(Build.BuildId).zip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deployToSlotOrASE</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">slotName</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">deploymentMethod</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;auto&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap stage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dependsOn</span><span class="p">:</span><span class="w"> </span><span class="l">Deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">succeeded()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">deployment</span><span class="p">:</span><span class="w"> </span><span class="l">SlotSwap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="l">Slot Swap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">runOnce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Start Swap With Preview&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(functionAppName)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">PowerShell@2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Wait for endpoint to respond&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">targetType</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;inline&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l">| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">Do {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">try {</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="l">$response = Invoke-RestMethod -Uri &#39;$(statusEndpointUri)&#39; -TimeoutSec 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>}<span class="w"> </span><span class="l">catch {}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">Start-Sleep -Seconds 2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>}<span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="l">while (-not $response)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">pwsh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l">AzureAppServiceManage@0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">displayName</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Complete Slot Swap&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">azureSubscription</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;$(azureSubscription)&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Swap Slots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">WebAppName</span><span class="p">:</span><span class="w"> </span><span class="l">$(functionAppName)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ResourceGroupName</span><span class="p">:</span><span class="w"> </span><span class="l">$(resourceGroup)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">SourceSlot</span><span class="p">:</span><span class="w"> </span><span class="l">$(sourceSlot)</span><span class="w">
</span></span></span></code></pre></div><p>Deployment slots are great to use when doing CI/CD pipelines as long as you understand how it works. It took me a while to figure all this out so I hope you find this post helpful.</p>


            <p>- Written by John  
            
                
                
                on October 29, 2020</p>

            
                <div class="disqus-section">
                    
                </div>
            
        </div>

    </div>
    


            </div>
        </div>
        
        
        
        
    </body>
</html>
