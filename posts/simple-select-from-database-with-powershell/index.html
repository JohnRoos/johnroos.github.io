<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>RoosTech | Simple select from database with PowerShell</title>
    <meta name="description" content="There are a few ways of getting data from SQL Server in PowerShell. This is one way of doing it which is quite simple and does not require the SQL Server module. The sample below shows how to get started. If you are planning on creating a script for serious use you need to add error handling and investigate a bit more what each line actually does so that you are in full control."/>
</head><body>
        <div class="container">

<nav class="navbar navbar-expand-lg navbar-dark ">
    <a class="navbar-brand" href="/">
        <div class="logo">RoosTech.se</div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
   


        
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/"> Home</a>
              </li>
            
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/gists/"> Gists</a>
              </li>
            
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/parameter-validation/"> Parameter validation</a>
              </li>
            
        

      </ul>

      <ul class="navbar-nav mr-right">

        
        
            
                <li class="nav-item navbar-right ">
                <a class="nav-link" href="/about/"> About me</a>
                </li>
            
        

        
      </ul>
    </div>
  </nav>

<div class="row">
                <div class="col-sm-9 blog-main section" id="blogposts">
<div class="blog-post">
  
    
    
    <time class="postdate" datetime="2015-07-14">Jul 14, 2015</time>

  <h1>Simple select from database with PowerShell</h1>
  <p>There are a few ways of getting data from SQL Server in PowerShell. This is one way of doing it which is quite simple and does not require the SQL Server module. The sample below shows how to get started. If you are planning on creating a script for serious use you need to add error handling and investigate a bit more what each line actually does so that you are in full control. Note that this is only for select statements. Insert, update and delete works slightly different, but I might get to that in the future.</p>
<p>To get started I have added three variables which you can use to adapt to your environment.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$server</span>   <span class="p">=</span> <span class="s1">&#39;localhost\sqlexpress&#39;</span>
<span class="nv">$database</span> <span class="p">=</span> <span class="s1">&#39;myDB&#39;</span>
<span class="nv">$query</span>    <span class="p">=</span> <span class="s1">&#39;select * from myTable&#39;</span>
</code></pre></div><p>After that we need to set up the objects needed to communicate with the database.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$connection</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlConnection</span>
<span class="nv">$adapter</span>    <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlDataAdapter</span> <span class="nv">$command</span>
<span class="nv">$dataset</span>    <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataSet</span>
</code></pre></div><p>Next is the connection string, which should work with most installations of SQL Server. After the connection string is created we open the connection to the server.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$connection</span><span class="p">.</span><span class="n">ConnectionString</span> <span class="p">=</span> <span class="s2">&#34;Server=$server;Database=$database;Trusted_Connection=True;&#34;</span>
<span class="nv">$connection</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>
</code></pre></div><p>The query need to be a proper command object, so lets do that.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$command</span> <span class="p">=</span> <span class="nv">$connection</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">()</span>
<span class="nv">$command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="nv">$query</span>
</code></pre></div><p>Fill the dataset with the result from the database. Lets also count the rows while we are at it.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$rowCount</span> <span class="p">=</span> <span class="nv">$adapter</span><span class="p">.</span><span class="n">Fill</span><span class="p">(</span><span class="nv">$dataset</span><span class="p">)</span>
</code></pre></div><p>Now we dont need the connection to the database anymore, so lets close it.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$connection</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</code></pre></div><p>Now we are done! Return the rows.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$dataset</span><span class="p">.</span><span class="n">Tables</span><span class="p">.</span><span class="n">rows</span>
</code></pre></div><p>Optionally you can also print the row count to the screen.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">Write-Host</span> <span class="s2">&#34;Rows returned: $rowCount&#34;</span>
</code></pre></div><p>That&rsquo;s how simple it can be to use a select statement with SQL Server.</p>
<h2 id="full-script">Full script</h2>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Variables for server, database and query</span>
<span class="nv">$server</span>   <span class="p">=</span> <span class="s1">&#39;localhost\sqlexpress&#39;</span>
<span class="nv">$database</span> <span class="p">=</span> <span class="s1">&#39;test&#39;</span>
<span class="nv">$query</span>    <span class="p">=</span> <span class="s1">&#39;select top 10 * from fjutt&#39;</span>

<span class="c"># Set up the objects needed</span>
<span class="nv">$connection</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlConnection</span>
<span class="nv">$adapter</span>    <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SqlClient</span><span class="p">.</span><span class="n">SqlDataAdapter</span> <span class="nv">$command</span>
<span class="nv">$dataset</span>    <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataSet</span>

<span class="c"># Set the connection string (using single sign on) and open the connection</span>
<span class="nv">$connection</span><span class="p">.</span><span class="n">ConnectionString</span> <span class="p">=</span> <span class="s2">&#34;Server=$server;Database=$database;Trusted_Connection=True;&#34;</span>
<span class="nv">$connection</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="c"># Create a command object and assign the query</span>
<span class="nv">$command</span> <span class="p">=</span> <span class="nv">$connection</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">()</span>
<span class="nv">$command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="nv">$query</span>

<span class="c"># Fill the dataset and count the rows returned at the same time</span>
<span class="nv">$rowCount</span> <span class="p">=</span> <span class="nv">$adapter</span><span class="p">.</span><span class="n">Fill</span><span class="p">(</span><span class="nv">$dataset</span><span class="p">)</span>

<span class="c"># Since the dataset is populated we can now close the connection</span>
<span class="nv">$connection</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

<span class="c"># Return the results</span>
<span class="nv">$dataset</span><span class="p">.</span><span class="n">Tables</span><span class="p">.</span><span class="n">rows</span>

<span class="c"># Print amount of rows to screen (optional)</span>
<span class="nb">Write-Host</span> <span class="s2">&#34;Rows returned: $rowCount&#34;</span>
</code></pre></div>
  <div class="blog-post-meta-bottom">
    
        Posted by: John<br />
    
    
        Tags: 
                PowerShell
            
                SQL Server
            
    
  </div>

  
    <div class="related-posts">
      
      
      <h3>Related posts</h3>
      <ul>
        
        <li><a href="/posts/powershell-script-write-object-to-sql/">Powershell script: Write object to SQL</a></li>
        
        <li><a href="/posts/making-powershell-expressions-easier/">Making PowerShell expressions easier</a></li>
        
        <li><a href="/posts/how-to-use-splatting-in-powershell/">How to use splatting in PowerShell</a></li>
        
        <li><a href="/posts/get-imdbmovie-using-invoke-webrequest/">Get-IMDBmovie using Invoke-WebRequest</a></li>
        
        <li><a href="/posts/classes-in-powershell-5.0/">Classes in Powershell 5.0</a></li>
        
      </ul>
    </div>
    
  
</div>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-test-roostech-se" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




                </div>
                <div class="col-sm-3 col-sm-offset0 blog-sidebar section" id="sidebar"><div id="sidebar">
    
    <div class="author">
        <img width="120" height="120" alt="John Roos" src="/img/face.jpg"><br>
        <a title="About John Roos" href="http://test.roostech.se/about">John Roos</a>
    </div>
    
    <div id="recentPosts">
            <div class="recentposts">
                <div class="recentposts-header">RECENT POSTS</div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/pester-5-discovery-and-testcases/">Pester 5: Discovery and TestCases</a></h1>
                    Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discover...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/create-and-use-azure-table-storage-with-powershell/">Create and use Azure Table storage with PowerShell</a></h1>
                    Azure Table storage is a quick and easy way to store data in the cloud. If you have an Azure subscription you can play around with you are up and running within minutes. Here is a short example on how to get started.
Create t...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/">Use Edit-Command to discover the code behind built-in cmdlets</a></h1>
                    Did you know that there are a lot of built-in cmdlets which are written entirely in PowerShell? Did you also know that you can view the source of those cmdlets? Well, you can. Get-Command shows all the details we need. When y...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/invoke-restmethod-with-anti-forgery-tokens-in-header-and-cookie/">Invoke-RestMethod with anti-forgery tokens in header and cookie</a></h1>
                    To help prevent cross-site scripting attacks some websites uses anti-forgery tokens. If you would like to talk to a REST API which uses this security measure you might run into problems if you are trying to use the PowerShell...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/introducing-the-inimanager-module/">Introducing the IniManager module</a></h1>
                    Some time ago I wanted to find a DSC resource which would help me in configuring ini files. I did not really find any resource which was dynamic enough for my needs so I ended up writing my own. Since I want my DSC resources ...
                </div>
            
            </div>
    </div>

</div></div>
            </div>
            <footer class="footer"><div class="feet">
<p class="footer text-center">Copyright (c) 2020 John Roos</p>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</footer>
        </div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</body>
</html>