<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>RoosTech | Use PowerShell jobs to ping many from many with log</title>
    <meta name="description" content="Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur."/>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-35019756-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head><body>
        <div class="container">

<nav class="navbar navbar-expand-lg navbar-dark ">
    <a class="navbar-brand" href="/">
        <div class="logo">RoosTech.se</div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
   


        
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/"> Home</a>
              </li>
            
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/gists/"> Gists</a>
              </li>
            
        
            
              <li class="nav-item ">
                <a class="nav-link" href="/parameter-validation/"> Parameter validation</a>
              </li>
            
        

      </ul>

      <ul class="navbar-nav mr-right">

        
        
            
                <li class="nav-item navbar-right ">
                <a class="nav-link" href="/about/"> About me</a>
                </li>
            
        

        
      </ul>
    </div>
  </nav>

<div class="row">
                <div class="col-sm-9 blog-main section" id="blogposts">
  <div class="blog-post">
    
    
    
    <time class="postdate" datetime="2016-02-06">Feb 6, 2016</time>

    <h1>Use PowerShell jobs to ping many from many with log</h1>
    
    
    
    <p>Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur. A few lines of code is all you need to get around that.</p>
<h2 id="use-powershell-jobs-for-ping">Use PowerShell jobs for ping</h2>
<p>I wrote a small script for this which can come in handy. You can use this script to ping several machines from multiple machines and store the results to logfiles in csv format. If a ping gets a timeout then the response time will be set to 9999.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$sources</span> <span class="p">=</span> <span class="s1">&#39;server1&#39;</span><span class="p">,</span> <span class="s1">&#39;server2&#39;</span><span class="p">,</span> <span class="s1">&#39;server3&#39;</span>
<span class="nv">$targets</span> <span class="p">=</span> <span class="s1">&#39;server4&#39;</span><span class="p">,</span> <span class="s1">&#39;server5&#39;</span>
<span class="nv">$logpath</span> <span class="p">=</span> <span class="s1">&#39;C:\Ping_logs\&#39;</span>
 
<span class="nv">$pingscript</span> <span class="p">=</span> <span class="p">{</span> 
    <span class="k">while</span> <span class="p">(</span><span class="nv">$true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$pingdate</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="n">u</span>
        <span class="nv">$logpath</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">2</span><span class="p">])$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nb">Get-Date</span> <span class="o">-f</span> <span class="n">yyyy-MM-dd</span><span class="p">)</span><span class="s2">.log&#34;</span>
        <span class="k">Try</span> <span class="p">{</span>
            <span class="nb">Test-Connection</span> <span class="n">-Count</span> <span class="n">1</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span> <span class="n">-Source</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span> <span class="n">-ComputerName</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="p">{</span><span class="nv">$pingdate</span><span class="p">},</span> <span class="n">__SERVER</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">ResponseTime</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">ConvertTo-Csv</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nv">$responseprops</span> <span class="p">=</span> <span class="no">[ordered]</span><span class="p">@{</span>
                <span class="s1">&#39;datetime&#39;</span> <span class="p">=</span> <span class="nv">$pingdate</span>
                <span class="s1">&#39;__SERVER&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
                <span class="s1">&#39;Address&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">]</span>
                <span class="s1">&#39;ResponseTime&#39;</span> <span class="p">=</span> <span class="s1">&#39;9999&#39;</span>
            <span class="p">}</span>
            <span class="nv">$response</span>  <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="nv">$responseprops</span>
            <span class="nb">ConvertTo-Csv</span> <span class="n">-InputObject</span> <span class="nv">$response</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span>
        <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="n">1</span>
    <span class="p">}</span> 
<span class="p">}</span>
 
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$source</span> <span class="k">in</span> <span class="nv">$sources</span><span class="p">){</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$target</span> <span class="k">in</span> <span class="nv">$targets</span><span class="p">){</span>
        <span class="nb">Start-Job</span> <span class="n">-Name</span> <span class="s2">&#34;$source ping $target&#34;</span> <span class="p">`</span>
                  <span class="n">-ScriptBlock</span> <span class="nv">$pingscript</span> <span class="p">`</span>
                  <span class="n">-ArgumentList</span> <span class="nv">$source</span><span class="p">,</span> <span class="nv">$target</span><span class="p">,</span> <span class="nv">$logpath</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>There will be one logfile for each source-target combination. In the example above there will be six logfiles per day. The script creates powershell jobs which runs in the background as long as the session is active or until you stop the jobs. You can easily stop and remove the jobs with the following command line:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">Get-Job</span> <span class="p">|</span> <span class="nb">Stop-Job</span> <span class="n">-PassThru</span> <span class="p">|</span> <span class="nb">Remove-Job</span>
</code></pre></div><h2 id="store-log-files-in-database">Store log files in database</h2>
<p>If you want the jobs to run for a long time (I had this running for a couple if weeks at one point) you will end up with a large amount of data. In this case its really helpful to put all the results into a database, whuch you can do with Write-ObjectToSQL which I have written about in the past. This is how you can import the csv files into a database.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$csv</span> <span class="p">=</span> <span class="nb">Import-Csv</span> <span class="n">-Path</span> <span class="n">C:</span><span class="p">\</span><span class="n">Ping_logs</span><span class="p">\</span><span class="n">Server1_Server2_2016</span><span class="p">-</span><span class="n">02</span><span class="p">-</span><span class="n">06</span><span class="p">.</span><span class="n">log</span>
<span class="nb">Write-ObjectToSQL</span> <span class="nv">$csv</span> <span class="n">-Server</span> <span class="n">localhost</span> <span class="n">-Database</span> <span class="n">PingDB</span> <span class="n">-TableName</span> <span class="n">PingLog</span>
</code></pre></div>
    
    <div class="blog-post-meta-bottom">
      
          Posted by: John<br />
      
      
          Tags: 
                  Error handling
              
                  Jobs
              
                  Ping
              
                  PowerShell
              
                  Test-Connection
              
                  Write-ObjectToSQL
              
      
    </div>

    
      <div class="related-posts">
        
        
        <h3>Related posts</h3>
        <ul>
          
          <li><a href="/posts/powershell-script-write-object-to-sql/">Powershell script: Write object to SQL</a></li>
          
          <li><a href="/posts/powershell-logo-made-with-css3/">PowerShell logo made with CSS3</a></li>
          
          <li><a href="/posts/what-is-this-here-string-people-are-talking-about/">What is this here-string people are talking about?</a></li>
          
          <li><a href="/posts/dynamic-parameters-in-powershell-executes-before-you-know-it/">Dynamic parameters in PowerShell executes before you know it</a></li>
          
          <li><a href="/posts/making-powershell-expressions-easier/">Making PowerShell expressions easier</a></li>
          
        </ul>
      </div>
      
    
  </div>

  
    <div class="disqus-section">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-roostech-se" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  

                </div>
                <div class="col-sm-3 col-sm-offset0 blog-sidebar section" id="sidebar"><div id="sidebar">
   
    <div class="author">
        <img width="120" height="120" alt="John Roos" src="/img/face.jpg"><br>
        <a title="About John Roos" href="http://blog.roostech.se/about">John Roos</a>
    </div>
   
    <div id="recentPosts">
            <div class="recentposts">
                <div class="recentposts-header">RECENT POSTS</div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/moving-from-blogger-to-github-pages-with-hugo/">Moving from Blogger to GitHub Pages using Hugo</a></h1>
                    For a while now I have felt that it takes too long time for me to write blog posts. I spend a long time figuring out how to make the post look right, when I should be spending time on the content. In the end this puts me off ...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/pester-5-discovery-and-testcases/">Pester 5: Discovery and TestCases</a></h1>
                    Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discover...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/create-and-use-azure-table-storage-with-powershell/">Create and use Azure Table storage with PowerShell</a></h1>
                    Azure Table storage is a quick and easy way to store data in the cloud. If you have an Azure subscription you can play around with you are up and running within minutes. Here is a short example on how to get started.
Create t...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/">Use Edit-Command to discover the code behind built-in cmdlets</a></h1>
                    Did you know that there are a lot of built-in cmdlets which are written entirely in PowerShell? Did you also know that you can view the source of those cmdlets? Well, you can. Get-Command shows all the details we need. When y...
                </div>
            
                <div class="recent">
                    <h1><a class="title" href="/posts/invoke-restmethod-with-anti-forgery-tokens-in-header-and-cookie/">Invoke-RestMethod with anti-forgery tokens in header and cookie</a></h1>
                    To help prevent cross-site scripting attacks some websites uses anti-forgery tokens. If you would like to talk to a REST API which uses this security measure you might run into problems if you are trying to use the PowerShell...
                </div>
            
            </div>
    </div>

</div></div>
            </div>
            <footer class="footer"><div class="feet">
<p class="footer text-center">Copyright (c) 2020 John Roos</p>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</footer>
        </div>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
</body>
</html>