 
 

 

 

 

 

 


<!DOCTYPE html>
<html lang="en">




    



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=5.0, minimum-scale=0.86">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <meta name='twitter:card'        content='summary' />
    <meta name='twitter:site'        content='@johnmroos'/>
    <meta name='twitter:creator'     content='@johnmroos'/>
    <meta name='twitter:title'       content='Use PowerShell jobs to ping many from many with log' />
    <meta name='twitter:description' content='Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur.' />
    
    <meta name='twitter:domain'      content='https://blog.roostech.se/'/>
    

    <title>Use PowerShell jobs to ping many from many with log</title>
    <meta name="description" content="Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur."/>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-35019756-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head><body>
        <div class="container">
<input class="explorer-toggle" type="checkbox" id="explorer-toggle">
<label class="explorer-toggle-label" for="explorer-toggle"><div class="explorer-toggle-label-clickablearea"></div></label>

<div class="explorer-toggle-label-selection"></div>

<div class="left-menu-button-bar"></div>

<diV class='left-menu'>
    
    <ul class="root">
        <li class="root"><div class="menu-item folder open"><a class="menu-item-site" href="https://blog.roostech.se/">blog.roostech.se (HUGOVSCODE)</a></div>
            <ul>  
                <li><span class="menu-item folder open">content</span>
                    <ul>
                        <li><span class="menu-item folder open">posts</span>
                            <ul>
                                
                                <li ><a href="/posts/get-function-configuration-from-deployed-function-app/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get function configuration from deployed Function App.md</span></a></li>
                                
                                <li ><a href="/posts/deploy-azure-function-app-without-downtime/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Deploy Azure Function App without downtime.md</span></a></li>
                                
                                <li ><a href="/posts/moving-from-blogger-to-github-pages-with-hugo/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Moving from Blogger to GitHub Pages using Hugo.md</span></a></li>
                                
                                <li ><a href="/posts/pester-5-discovery-and-testcases/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Pester 5: Discovery and TestCases.md</span></a></li>
                                
                                <li ><a href="/posts/create-and-use-azure-table-storage-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Create and use Azure Table storage with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use Edit-Command to discover the code behind built-in cmdlets.md</span></a></li>
                                
                                <li ><a href="/posts/invoke-restmethod-with-anti-forgery-tokens-in-header-and-cookie/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Invoke-RestMethod with anti-forgery tokens in header and cookie.md</span></a></li>
                                
                                <li ><a href="/posts/introducing-the-inimanager-module/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Introducing the IniManager module.md</span></a></li>
                                
                                <li class="current"><a href="/posts/use-powershell-jobs-to-ping-many-from-many-with-log/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use PowerShell jobs to ping many from many with log.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-logo-made-with-css3/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">PowerShell logo made with CSS3.md</span></a></li>
                                
                                <li ><a href="/posts/what-is-this-here-string-people-are-talking-about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">What is this here-string people are talking about?.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-parameters-in-powershell-executes-before-you-know-it/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic parameters in PowerShell executes before you know it.md</span></a></li>
                                
                                <li ><a href="/posts/making-powershell-expressions-easier/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Making PowerShell expressions easier.md</span></a></li>
                                
                                <li ><a href="/posts/simple-select-from-database-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Simple select from database with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-use-splatting-in-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to use splatting in PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/get-imdbmovie-using-invoke-webrequest/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-IMDBmovie using Invoke-WebRequest.md</span></a></li>
                                
                                <li ><a href="/posts/classes-in-powershell-5.0/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Classes in Powershell 5.0.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-get-started-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to get started with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-find-hotfix-status/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Find hotfix status.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-write-object-to-sql/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Write object to SQL.md</span></a></li>
                                
                                <li ><a href="/posts/get-type-alternative-for-null-values/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-Type alternative for $null values.md</span></a></li>
                                
                                <li ><a href="/posts/compress-files-to-zip-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Compress files to Zip with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/enable-real-time-jmx-monitoring-in-cognos/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Enable real time JMX monitoring in Cognos.md</span></a></li>
                                
                                <li ><a href="/posts/move-data-or-log-files-for-tempdb-in-sql-server/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Move data or log files for TempDB in SQL Server.md</span></a></li>
                                
                                <li ><a href="/posts/resources-for-remotefx-in-windows-server-2012/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Resources for RemoteFX in Windows Server 2012.md</span></a></li>
                                
                                <li ><a href="/posts/rdp-8.0-for-windows-7-sp1/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">RDP 8.0 for Windows 7 SP1.md</span></a></li>
                                
                                <li ><a href="/posts/improving-remotefx-performance-in-hyper-v/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Improving RemoteFX performance in Hyper-V.md</span></a></li>
                                
                                <li ><a href="/posts/configure-remotefx-in-hyper-v-running-windows-server-2012-with-low-end-gpu/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Configure RemoteFX in Hyper-V running Windows Server 2012 with low end GPU.md</span></a></li>
                                
                                <li ><a href="/posts/sqlps-and-its-limitations/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">SQLPS and its limitations.md</span></a></li>
                                
                                <li ><a href="/posts/script-deployment-of-ssis-packages-from-folder/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Script deployment of SSIS packages from folder.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-deploy-of-ssrs-reports-using-rs.exe/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic deploy of SSRS reports using rs.exe.md</span></a></li>
                                
                                <li ><a href="/posts/remove-headers-in-excel-exports-to-fix-column-alignment/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Remove headers in Excel exports to fix column alignment.md</span></a></li>
                                
                                <li ><a href="/posts/using-executionlog2-for-statistics-and-monitoring/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Using ExecutionLog2 for statistics and monitoring.md</span></a></li>
                                
                            </ul>
                        </li>
                        <li><span class="menu-item folder open">pages</span>
                            <ul>
                                
                                <li ><a href="/about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">About me.md</span></a></li>
                                
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><span class="menu-item folder">data</span></li>
                <li><span class="menu-item folder">layouts</span></li>
                <li><span class="menu-item folder">resources</span></li>
                <li><span class="menu-item folder">static</span></li>
                <li><span class="menu-item folder open">themes</span>
                    <ul>
                        <li><span class="menu-item folder open">hugovscode</span>
                            <ul>
                                <li><a href="https://github.com/JohnRoos/HugoVSCode/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">.git</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>config.toml</li>
            </ul>
        </li>
    </ul>
  

    
</diV>
                <div class ="main-tabs">
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/">Home.md</a> 
                    </div>
                
                    <div class="main-tab current">
                        <span class="rotate-letter md-icon">&#10144;</span> <i>Use PowerShell jobs to ping many from many with log.md</i> 
                    </div>
                
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/get-function-configuration-from-deployed-function-app/">Get function configuration from deployed Function App.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/deploy-azure-function-app-without-downtime/">Deploy Azure Function App without downtime.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/moving-from-blogger-to-github-pages-with-hugo/">Moving from Blogger to GitHub Pages using Hugo.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/pester-5-discovery-and-testcases/">Pester 5: Discovery and TestCases.md</a>
                    </div>
                
                    <div class="main-tab">
                        <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/create-and-use-azure-table-storage-with-powershell/">Create and use Azure Table storage with PowerShell.md</a>
                    </div>
                
                </div>
            
            
            <div class='main'>
    <div class="main-path">
        <span><a class="path-link" href="https://blog.roostech.se/">blog.roostech.se</a></span><span class="folder">content</span><span class="folder">posts</span><span class="folder">Use PowerShell jobs to ping many from many with log.md</span>
        
                
                
                <span class="postdate-container">&nbsp;(<time class="postdate" datetime="2016-02-06">February 6, 2016</time>)</span>
            
    </div>
    
    <div class="main-content-toggle">

        
        <input class="source-preview-split" type="checkbox" id="source-preview-split-toggle">
        <label class="source-preview-split-label" for="source-preview-split-toggle"></label>

        <input class="source-toggle" type="checkbox" id="source-toggle">
        <label class="source-toggle-label" for="source-toggle"></label>

        <div class="main-content">
            ---<br />
            <span class="md-frontmatter">title</span>: <span class="md-frontmatter-string">Use PowerShell jobs to ping many from many with log</span><br />
            <span class="md-frontmatter">date</span>: 2016-02-06 14:14:00 &#43;0200 &#43;0200<br />
            <span class="md-frontmatter">draft</span>: <span class="md-frontmatter">false</span><br />
            <span class="md-frontmatter">author</span>: <span class="md-frontmatter-string">John</span><br />
            ----
            <p>Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur. A few lines of code is all you need to get around that.</p>
<h2 id="use-powershell-jobs-for-ping">Use PowerShell jobs for ping</h2>
<p>I wrote a small script for this which can come in handy. You can use this script to ping several machines from multiple machines and store the results to logfiles in csv format. If a ping gets a timeout then the response time will be set to 9999.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$sources</span> <span class="p">=</span> <span class="s1">&#39;server1&#39;</span><span class="p">,</span> <span class="s1">&#39;server2&#39;</span><span class="p">,</span> <span class="s1">&#39;server3&#39;</span>
<span class="nv">$targets</span> <span class="p">=</span> <span class="s1">&#39;server4&#39;</span><span class="p">,</span> <span class="s1">&#39;server5&#39;</span>
<span class="nv">$logpath</span> <span class="p">=</span> <span class="s1">&#39;C:\Ping_logs\&#39;</span>
 
<span class="nv">$pingscript</span> <span class="p">=</span> <span class="p">{</span> 
    <span class="k">while</span> <span class="p">(</span><span class="nv">$true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$pingdate</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="n">u</span>
        <span class="nv">$logpath</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">2</span><span class="p">])$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nb">Get-Date</span> <span class="o">-f</span> <span class="n">yyyy-MM-dd</span><span class="p">)</span><span class="s2">.log&#34;</span>
        <span class="k">Try</span> <span class="p">{</span>
            <span class="nb">Test-Connection</span> <span class="n">-Count</span> <span class="n">1</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span> <span class="n">-Source</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span> <span class="n">-ComputerName</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="p">{</span><span class="nv">$pingdate</span><span class="p">},</span> <span class="n">__SERVER</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">ResponseTime</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">ConvertTo-Csv</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nv">$responseprops</span> <span class="p">=</span> <span class="no">[ordered]</span><span class="p">@{</span>
                <span class="s1">&#39;datetime&#39;</span> <span class="p">=</span> <span class="nv">$pingdate</span>
                <span class="s1">&#39;__SERVER&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
                <span class="s1">&#39;Address&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">]</span>
                <span class="s1">&#39;ResponseTime&#39;</span> <span class="p">=</span> <span class="s1">&#39;9999&#39;</span>
            <span class="p">}</span>
            <span class="nv">$response</span>  <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="nv">$responseprops</span>
            <span class="nb">ConvertTo-Csv</span> <span class="n">-InputObject</span> <span class="nv">$response</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span>
        <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="n">1</span>
    <span class="p">}</span> 
<span class="p">}</span>
 
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$source</span> <span class="k">in</span> <span class="nv">$sources</span><span class="p">){</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$target</span> <span class="k">in</span> <span class="nv">$targets</span><span class="p">){</span>
        <span class="nb">Start-Job</span> <span class="n">-Name</span> <span class="s2">&#34;$source ping $target&#34;</span> <span class="p">`</span>
                  <span class="n">-ScriptBlock</span> <span class="nv">$pingscript</span> <span class="p">`</span>
                  <span class="n">-ArgumentList</span> <span class="nv">$source</span><span class="p">,</span> <span class="nv">$target</span><span class="p">,</span> <span class="nv">$logpath</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>There will be one logfile for each source-target combination. In the example above there will be six logfiles per day. The script creates powershell jobs which runs in the background as long as the session is active or until you stop the jobs. You can easily stop and remove the jobs with the following command line:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">Get-Job</span> <span class="p">|</span> <span class="nb">Stop-Job</span> <span class="n">-PassThru</span> <span class="p">|</span> <span class="nb">Remove-Job</span>
</code></pre></div><h2 id="store-log-files-in-database">Store log files in database</h2>
<p>If you want the jobs to run for a long time (I had this running for a couple if weeks at one point) you will end up with a large amount of data. In this case its really helpful to put all the results into a database, whuch you can do with Write-ObjectToSQL which I have written about in the past. This is how you can import the csv files into a database.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$csv</span> <span class="p">=</span> <span class="nb">Import-Csv</span> <span class="n">-Path</span> <span class="n">C:</span><span class="p">\</span><span class="n">Ping_logs</span><span class="p">\</span><span class="n">Server1_Server2_2016</span><span class="p">-</span><span class="n">02</span><span class="p">-</span><span class="n">06</span><span class="p">.</span><span class="n">log</span>
<span class="nb">Write-ObjectToSQL</span> <span class="nv">$csv</span> <span class="n">-Server</span> <span class="n">localhost</span> <span class="n">-Database</span> <span class="n">PingDB</span> <span class="n">-TableName</span> <span class="n">PingLog</span>
</code></pre></div>
        </div>

        
        <div class="main-content-preview">
            <h1>Use PowerShell jobs to ping many from many with log</h1>
            
            <p>Once in a while you want to check how stable a connection is between computers. You might want to ping one or two machines from several others to find out if there is some issues with the network somewhere. You could use the built-in cmdlet Test-Connection and log the results to a log file but then you will not be able to log timeouts since the cmdlet returns an error when timeouts occur. A few lines of code is all you need to get around that.</p>
<h2 id="use-powershell-jobs-for-ping">Use PowerShell jobs for ping</h2>
<p>I wrote a small script for this which can come in handy. You can use this script to ping several machines from multiple machines and store the results to logfiles in csv format. If a ping gets a timeout then the response time will be set to 9999.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$sources</span> <span class="p">=</span> <span class="s1">&#39;server1&#39;</span><span class="p">,</span> <span class="s1">&#39;server2&#39;</span><span class="p">,</span> <span class="s1">&#39;server3&#39;</span>
<span class="nv">$targets</span> <span class="p">=</span> <span class="s1">&#39;server4&#39;</span><span class="p">,</span> <span class="s1">&#39;server5&#39;</span>
<span class="nv">$logpath</span> <span class="p">=</span> <span class="s1">&#39;C:\Ping_logs\&#39;</span>
 
<span class="nv">$pingscript</span> <span class="p">=</span> <span class="p">{</span> 
    <span class="k">while</span> <span class="p">(</span><span class="nv">$true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$pingdate</span> <span class="p">=</span> <span class="nb">Get-Date</span> <span class="n">-Format</span> <span class="n">u</span>
        <span class="nv">$logpath</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">2</span><span class="p">])$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span><span class="s2">_</span><span class="p">$(</span><span class="nb">Get-Date</span> <span class="o">-f</span> <span class="n">yyyy-MM-dd</span><span class="p">)</span><span class="s2">.log&#34;</span>
        <span class="k">Try</span> <span class="p">{</span>
            <span class="nb">Test-Connection</span> <span class="n">-Count</span> <span class="n">1</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span> <span class="n">-Source</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">])</span> <span class="n">-ComputerName</span> <span class="p">$(</span><span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">])</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="p">{</span><span class="nv">$pingdate</span><span class="p">},</span> <span class="n">__SERVER</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">ResponseTime</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">ConvertTo-Csv</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nv">$responseprops</span> <span class="p">=</span> <span class="no">[ordered]</span><span class="p">@{</span>
                <span class="s1">&#39;datetime&#39;</span> <span class="p">=</span> <span class="nv">$pingdate</span>
                <span class="s1">&#39;__SERVER&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">0</span><span class="p">]</span>
                <span class="s1">&#39;Address&#39;</span> <span class="p">=</span> <span class="nv">$args</span><span class="p">[</span><span class="n">1</span><span class="p">]</span>
                <span class="s1">&#39;ResponseTime&#39;</span> <span class="p">=</span> <span class="s1">&#39;9999&#39;</span>
            <span class="p">}</span>
            <span class="nv">$response</span>  <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">psobject</span> <span class="n">-Property</span> <span class="nv">$responseprops</span>
            <span class="nb">ConvertTo-Csv</span> <span class="n">-InputObject</span> <span class="nv">$response</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Skip</span> <span class="n">2</span> <span class="p">`</span>
                <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-FilePath</span> <span class="nv">$logpath</span> <span class="n">-Append</span>
        <span class="p">}</span>
        <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="n">1</span>
    <span class="p">}</span> 
<span class="p">}</span>
 
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$source</span> <span class="k">in</span> <span class="nv">$sources</span><span class="p">){</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$target</span> <span class="k">in</span> <span class="nv">$targets</span><span class="p">){</span>
        <span class="nb">Start-Job</span> <span class="n">-Name</span> <span class="s2">&#34;$source ping $target&#34;</span> <span class="p">`</span>
                  <span class="n">-ScriptBlock</span> <span class="nv">$pingscript</span> <span class="p">`</span>
                  <span class="n">-ArgumentList</span> <span class="nv">$source</span><span class="p">,</span> <span class="nv">$target</span><span class="p">,</span> <span class="nv">$logpath</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>There will be one logfile for each source-target combination. In the example above there will be six logfiles per day. The script creates powershell jobs which runs in the background as long as the session is active or until you stop the jobs. You can easily stop and remove the jobs with the following command line:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nb">Get-Job</span> <span class="p">|</span> <span class="nb">Stop-Job</span> <span class="n">-PassThru</span> <span class="p">|</span> <span class="nb">Remove-Job</span>
</code></pre></div><h2 id="store-log-files-in-database">Store log files in database</h2>
<p>If you want the jobs to run for a long time (I had this running for a couple if weeks at one point) you will end up with a large amount of data. In this case its really helpful to put all the results into a database, whuch you can do with Write-ObjectToSQL which I have written about in the past. This is how you can import the csv files into a database.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$csv</span> <span class="p">=</span> <span class="nb">Import-Csv</span> <span class="n">-Path</span> <span class="n">C:</span><span class="p">\</span><span class="n">Ping_logs</span><span class="p">\</span><span class="n">Server1_Server2_2016</span><span class="p">-</span><span class="n">02</span><span class="p">-</span><span class="n">06</span><span class="p">.</span><span class="n">log</span>
<span class="nb">Write-ObjectToSQL</span> <span class="nv">$csv</span> <span class="n">-Server</span> <span class="n">localhost</span> <span class="n">-Database</span> <span class="n">PingDB</span> <span class="n">-TableName</span> <span class="n">PingLog</span>
</code></pre></div>

            <p>- Written by John  
            
                
                
                on February 6, 2016</p>

            
                <div class="disqus-section">
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-roostech-se" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            
        </div>

    </div>
    


            </div>
        </div>
    </body>
</html>
