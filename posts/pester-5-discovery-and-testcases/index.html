<!DOCTYPE html>
<html lang="en">




    



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=5.0, minimum-scale=0.86">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/syntax.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">

    <meta name='twitter:card'        content='summary' />
    <meta name='twitter:site'        content='@johnmroos'/>
    <meta name='twitter:creator'     content='@johnmroos'/>
    <meta name='twitter:title'       content='Pester 5: Discovery and TestCases' />
    <meta name='twitter:description' content='Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discovery works and how to use it to generate test cases.
Tests are executed in two phases Whenever you run tests with Pester 5 there will always be two phases, the Discovery phase and the Run phase.' />
    
    <meta name='twitter:domain'      content='https://blog.roostech.se/'/>
    

    <title>Pester 5: Discovery and TestCases</title>
    <meta name="description" content="Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discovery works and how to use it to generate test cases.
Tests are executed in two phases Whenever you run tests with Pester 5 there will always be two phases, the Discovery phase and the Run phase."/>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-35019756-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head><body>
        <div class="container">
<input class="explorer-toggle" type="checkbox" id="explorer-toggle">
<label class="explorer-toggle-label" for="explorer-toggle"><div class="explorer-toggle-label-clickablearea"></div></label>

<div class="explorer-toggle-label-selection"></div>

<div class="left-menu-button-bar"></div>

<diV class='left-menu'>
    
    <ul class="root">
        <li class="root"><span class="rotate-letter">></span><span class="menu-item"><a class="menu-item-site" href="https://blog.roostech.se/">blog.roostech.se (HUGOVSCODE)</a></span>
            <ul>  
                <li><span class="rotate-letter">></span><span class="menu-item">content</span>
                    <ul>
                        <li><span class="rotate-letter">></span><span class="menu-item">posts</span>
                            <ul>
                                
                                <li ><a href="/posts/deploy-azure-function-app-without-downtime/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Deploy Azure Function App without downtime.md</span></a></li>
                                
                                <li ><a href="/posts/moving-from-blogger-to-github-pages-with-hugo/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Moving from Blogger to GitHub Pages using Hugo.md</span></a></li>
                                
                                <li class="current"><a href="/posts/pester-5-discovery-and-testcases/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Pester 5: Discovery and TestCases.md</span></a></li>
                                
                                <li ><a href="/posts/create-and-use-azure-table-storage-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Create and use Azure Table storage with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use Edit-Command to discover the code behind built-in cmdlets.md</span></a></li>
                                
                                <li ><a href="/posts/invoke-restmethod-with-anti-forgery-tokens-in-header-and-cookie/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Invoke-RestMethod with anti-forgery tokens in header and cookie.md</span></a></li>
                                
                                <li ><a href="/posts/introducing-the-inimanager-module/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Introducing the IniManager module.md</span></a></li>
                                
                                <li ><a href="/posts/use-powershell-jobs-to-ping-many-from-many-with-log/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Use PowerShell jobs to ping many from many with log.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-logo-made-with-css3/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">PowerShell logo made with CSS3.md</span></a></li>
                                
                                <li ><a href="/posts/what-is-this-here-string-people-are-talking-about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">What is this here-string people are talking about?.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-parameters-in-powershell-executes-before-you-know-it/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic parameters in PowerShell executes before you know it.md</span></a></li>
                                
                                <li ><a href="/posts/making-powershell-expressions-easier/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Making PowerShell expressions easier.md</span></a></li>
                                
                                <li ><a href="/posts/simple-select-from-database-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Simple select from database with PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-use-splatting-in-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to use splatting in PowerShell.md</span></a></li>
                                
                                <li ><a href="/posts/get-imdbmovie-using-invoke-webrequest/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-IMDBmovie using Invoke-WebRequest.md</span></a></li>
                                
                                <li ><a href="/posts/classes-in-powershell-5.0/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Classes in Powershell 5.0.md</span></a></li>
                                
                                <li ><a href="/posts/how-to-get-started-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">How to get started with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-find-hotfix-status/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Find hotfix status.md</span></a></li>
                                
                                <li ><a href="/posts/powershell-script-write-object-to-sql/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Powershell script: Write object to SQL.md</span></a></li>
                                
                                <li ><a href="/posts/get-type-alternative-for-null-values/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Get-Type alternative for $null values.md</span></a></li>
                                
                                <li ><a href="/posts/compress-files-to-zip-with-powershell/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Compress files to Zip with Powershell.md</span></a></li>
                                
                                <li ><a href="/posts/enable-real-time-jmx-monitoring-in-cognos/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Enable real time JMX monitoring in Cognos.md</span></a></li>
                                
                                <li ><a href="/posts/move-data-or-log-files-for-tempdb-in-sql-server/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Move data or log files for TempDB in SQL Server.md</span></a></li>
                                
                                <li ><a href="/posts/resources-for-remotefx-in-windows-server-2012/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Resources for RemoteFX in Windows Server 2012.md</span></a></li>
                                
                                <li ><a href="/posts/rdp-8.0-for-windows-7-sp1/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">RDP 8.0 for Windows 7 SP1.md</span></a></li>
                                
                                <li ><a href="/posts/improving-remotefx-performance-in-hyper-v/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Improving RemoteFX performance in Hyper-V.md</span></a></li>
                                
                                <li ><a href="/posts/configure-remotefx-in-hyper-v-running-windows-server-2012-with-low-end-gpu/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Configure RemoteFX in Hyper-V running Windows Server 2012 with low end GPU.md</span></a></li>
                                
                                <li ><a href="/posts/sqlps-and-its-limitations/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">SQLPS and its limitations.md</span></a></li>
                                
                                <li ><a href="/posts/script-deployment-of-ssis-packages-from-folder/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Script deployment of SSIS packages from folder.md</span></a></li>
                                
                                <li ><a href="/posts/dynamic-deploy-of-ssrs-reports-using-rs.exe/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Dynamic deploy of SSRS reports using rs.exe.md</span></a></li>
                                
                                <li ><a href="/posts/remove-headers-in-excel-exports-to-fix-column-alignment/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Remove headers in Excel exports to fix column alignment.md</span></a></li>
                                
                                <li ><a href="/posts/using-executionlog2-for-statistics-and-monitoring/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Using ExecutionLog2 for statistics and monitoring.md</span></a></li>
                                
                            </ul>
                        </li>
                        <li><span class="rotate-letter">></span><span class="menu-item">pages</span>
                            <ul>
                                
                                <li ><a href="/about/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">About me.md</span></a></li>
                                
                                <li ><a href="/gists/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Gists.md</span></a></li>
                                
                                <li ><a href="/parameter-validation/"><span class="rotate-letter md-icon">&#10144;</span><span class="menu-item">Parameter Validation.md</span></a></li>
                                
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>><span class="menu-item">data</span></li>
                <li>><span class="menu-item">layouts</span></li>
                <li>><span class="menu-item">resources</span></li>
                <li>><span class="menu-item">static</span></li>
                <li>><span class="menu-item">themes</span></li>
                <li>config.toml</li>
            </ul>
        </li>
    </ul>
  

    
</diV><div class='main'>
     
     
     
    
     
    
     
    
    
    
     
    
     
    
    
        
        <div class="main-tabs">
            <div class="main-tabs-scroll">
                <div class="main-tabs-table">
                    <div class ="main-tabs-row">
                        <div class="main-tab">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/">Home.md</a> 
                        </div>
                    
                    
                        <div class="main-tab">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/deploy-azure-function-app-without-downtime/">Deploy Azure Function App without downtime.md</a>
                        </div>
                    
                        <div class="main-tab">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/moving-from-blogger-to-github-pages-with-hugo/">Moving from Blogger to GitHub Pages using Hugo.md</a>
                        </div>
                    
                        <div class="main-tab current">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/pester-5-discovery-and-testcases/">Pester 5: Discovery and TestCases.md</a>
                        </div>
                    
                        <div class="main-tab">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/create-and-use-azure-table-storage-with-powershell/">Create and use Azure Table storage with PowerShell.md</a>
                        </div>
                    
                        <div class="main-tab">
                            <span class="rotate-letter md-icon">&#10144;</span> <a href="/posts/use-edit-command-to-discover-the-code-behind-built-in-cmdlets/">Use Edit-Command to discover the code behind built-in cmdlets.md</a>
                        </div>
                    
                    </div>
                </div>
            </div>
        </div>
        <div class="main-path">
            <a class="path-link" href="https://blog.roostech.se/">blog.roostech.se</a> > content > posts &gt; Pester 5 - Discovery and TestCases.md
        </div>
        <div class="main-content-toggle">

            
            <input class="source-preview-split" type="checkbox" id="source-preview-split-toggle">
            <label class="source-preview-split-label" for="source-preview-split-toggle"></label>

            <input class="source-toggle" type="checkbox" id="source-toggle">
            <label class="source-toggle-label" for="source-toggle"></label>

            <div class="main-content">
                ---<br />
                <span class="md-frontmatter">title</span>: <span class="md-frontmatter-string">Pester 5: Discovery and TestCases</span><br />
                <span class="md-frontmatter">date</span>: 2020-05-29 14:14:00 &#43;0200 CEST<br />
                <span class="md-frontmatter">draft</span>: <span class="md-frontmatter">false</span><br />
                <span class="md-frontmatter">author</span>: <span class="md-frontmatter-string">John</span><br />
                ----
                <p>Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discovery works and how to use it to generate test cases.</p>
<h2 id="tests-are-executed-in-two-phases">Tests are executed in two phases</h2>
<p>Whenever you run tests with Pester 5 there will always be two phases, the <strong>Discovery</strong> phase and the <strong>Run</strong> phase. The Discovery phase, as the name implies, tries to discover which tests to run and prepare those tests so that they are ready when the next phase starts. The Run phase will execute the actual tests and evaluate the results.</p>
<h2 id="phase-isolation">Phase isolation</h2>
<p>Its important to understand that each of these phases are isolated from each other. Variables generated in the Discovery phase, for example, are not generally available in the Run phase. This is what stumbles a lot of people when they are getting started with Pester 5. Think of the two phases as two separate scripts which has little to do with each other. That&rsquo;s a very simplified way of explaining it, and Mr Jareš would probably say that its wrong, but thinking in that way makes it easier (at least for me) to understand it in the beginning. Once you wrap your mind around it, it makes a lot of sense.</p>
<h2 id="what-discovery-does">What Discovery does</h2>
<p>When you run a test, Pester will first start the discovery of your test script. During discovery Pester tries to figure out which tests should be executed. Once it has figured out which tests the next phase should run, it stores all the relevant script blocks from <strong>BeforeAll</strong>, <strong>BeforeEach</strong>, <strong>It</strong>, <strong>AfterAll</strong> and <strong>AfterEach</strong>. Now Pester is ready to execute the Run phase where the actual tests are processed.</p>
<h2 id="what-runs-when">What runs when</h2>
<p>All code within the script blocks for BeforeAll, BeforeEach, It, AfterAll and AfterEach will be executed during the Run phase and not during Discovery. Notice that I mentioned script blocks? That&rsquo;s right, everything else will be executed during Discovery. Lets do an example.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="nv">$ExpectedResult</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="p">}</span>
        <span class="nv">$MyVariable</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">It</span> <span class="s2">&#34;$MyVariable is true&#34;</span> <span class="p">{</span>
            <span class="s1">&#39;true&#39;</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$ExpectedResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This example would kind of look like this from a Discovery point of view:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
        <span class="nv">$MyVariable</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">It</span> <span class="s2">&#34;$MyVariable is true&#34;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The content of the script blocks for BeforeAll and It will not be executed, but everything else will. This has some interesting consequences. The variable <strong>$MyVariable</strong> will be processed during discovery. So will the name of the It block. The test itself will fail, because the <strong>$MyVariable</strong> has not been set inside either BeforeAll or It.</p>
<p>When discovery is completed, you could say that the remaining script to run for the Run phase would be the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="nv">$ExpectedResult</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="p">}</span>
        <span class="n">It</span> <span class="s2">&#34;true is true&#34;</span> <span class="p">{</span>
            <span class="s1">&#39;true&#39;</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$ExpectedResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="will-this-execute-in-discovery-or-run">Will this execute in Discovery or Run?</h2>
<p>The following example shows what parts of a test script runs during the Discovery versus the Run phase.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Discovery</span>
<span class="n">BeforeAll</span> <span class="p">{</span>
    <span class="c"># Run</span>
<span class="p">}</span>
<span class="n">Describe</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
    <span class="c"># Discovery</span>
    <span class="n">BeforeAll</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">BeforeEach</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">Context</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">BeforeEach</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="c"># Discovery</span>
        <span class="n">It</span> <span class="s2">&#34;Discovery&#34;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-TestCases</span> <span class="p">@{</span><span class="s1">&#39;Discovery&#39;</span> <span class="p">=</span> <span class="s1">&#39;Discovery&#39;</span><span class="p">}</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">AfterEach</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">AfterAll</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">AfterEach</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">AfterAll</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">AfterAll</span> <span class="p">{</span>
    <span class="c"># Run</span>
<span class="p">}</span>
<span class="c"># Discovery</span>
</code></pre></div><h2 id="generating-tests-with-testcases">Generating tests with TestCases</h2>
<p>If you want to dynamically generate tests in your scripts you have to write the script a bit different compared to Pester 4. Previously we could generate tests like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Pester 4</span>
<span class="n">Describe</span> <span class="s1">&#39;Pester 4 Example&#39;</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$number</span> <span class="k">in</span> <span class="n">1</span><span class="p">..</span><span class="n">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">It</span> <span class="s2">&#34;$number is a number&#34;</span> <span class="p">{</span>
            <span class="nv">$number</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeOfType</span> <span class="no">[int]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This would generate 10 tests in Pester 4 and everything would work. But in Pester 5 this would not work since we now have the discovery phase and the <strong>$number</strong> parameter would not be available inside the It block during the Test phase. Instead you can use the TestCases parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Pester 5</span>
<span class="n">Describe</span> <span class="s1">&#39;Pester 5 Example&#39;</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$number</span> <span class="k">in</span> <span class="n">1</span><span class="p">..</span><span class="n">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">It</span> <span class="s2">&#34;$number is a number&#34;</span> <span class="n">-TestCases</span> <span class="p">@{</span><span class="s1">&#39;digit&#39;</span> <span class="p">=</span> <span class="nv">$number</span><span class="p">}</span> <span class="p">{</span>
            <span class="nv">$digit</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeOfType</span> <span class="no">[int]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The reason for this is that <strong>all the parameters for the It command is evaluated in Discovery, except the script block</strong>. The foreach loop is located directly in the Describe block which means that it will be processed during Discovery as well.</p>
<h2 id="how-testcases-work">How TestCases work</h2>
<p>Notice that the variable <strong>$digit</strong> just magically appeared in the script block for It in the last example? Let me try to explain what happened there.</p>
<p>The TestCases parameter accepts a hash table. When the script block executes Pester will create variables for each key in the hash table. The following example shows how two variables are created from the TestCases parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$tests</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s1">&#39;First&#39;</span>  <span class="p">=</span> <span class="s1">&#39;word&#39;</span>
    <span class="s1">&#39;Second&#39;</span> <span class="p">=</span> <span class="s1">&#39;word&#39;</span>
<span class="p">}</span>

<span class="n">It</span> <span class="s2">&#34;first and second is the same&#34;</span> <span class="n">-TestCases</span> <span class="nv">$tests</span> <span class="p">{</span>
    <span class="nv">$First</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$Second</span>
<span class="p">}</span>
</code></pre></div><p>Understanding discovery is a major part of understanding Pester 5. I hope this post has helped answer a few questions.</p>

            </div>

            
            <div class="main-content-preview">
                <h1>Pester 5: Discovery and TestCases</h1>
                <p>Pester 5 was released a couple of days ago which brings a lot of new features and changes to how we write tests. One of the major changes in Pester 5 is the Discovery phase. In this post I will attempt to explain how Discovery works and how to use it to generate test cases.</p>
<h2 id="tests-are-executed-in-two-phases">Tests are executed in two phases</h2>
<p>Whenever you run tests with Pester 5 there will always be two phases, the <strong>Discovery</strong> phase and the <strong>Run</strong> phase. The Discovery phase, as the name implies, tries to discover which tests to run and prepare those tests so that they are ready when the next phase starts. The Run phase will execute the actual tests and evaluate the results.</p>
<h2 id="phase-isolation">Phase isolation</h2>
<p>Its important to understand that each of these phases are isolated from each other. Variables generated in the Discovery phase, for example, are not generally available in the Run phase. This is what stumbles a lot of people when they are getting started with Pester 5. Think of the two phases as two separate scripts which has little to do with each other. That&rsquo;s a very simplified way of explaining it, and Mr Jareš would probably say that its wrong, but thinking in that way makes it easier (at least for me) to understand it in the beginning. Once you wrap your mind around it, it makes a lot of sense.</p>
<h2 id="what-discovery-does">What Discovery does</h2>
<p>When you run a test, Pester will first start the discovery of your test script. During discovery Pester tries to figure out which tests should be executed. Once it has figured out which tests the next phase should run, it stores all the relevant script blocks from <strong>BeforeAll</strong>, <strong>BeforeEach</strong>, <strong>It</strong>, <strong>AfterAll</strong> and <strong>AfterEach</strong>. Now Pester is ready to execute the Run phase where the actual tests are processed.</p>
<h2 id="what-runs-when">What runs when</h2>
<p>All code within the script blocks for BeforeAll, BeforeEach, It, AfterAll and AfterEach will be executed during the Run phase and not during Discovery. Notice that I mentioned script blocks? That&rsquo;s right, everything else will be executed during Discovery. Lets do an example.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="nv">$ExpectedResult</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="p">}</span>
        <span class="nv">$MyVariable</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">It</span> <span class="s2">&#34;$MyVariable is true&#34;</span> <span class="p">{</span>
            <span class="s1">&#39;true&#39;</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$ExpectedResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This example would kind of look like this from a Discovery point of view:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
        <span class="nv">$MyVariable</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="n">It</span> <span class="s2">&#34;$MyVariable is true&#34;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The content of the script blocks for BeforeAll and It will not be executed, but everything else will. This has some interesting consequences. The variable <strong>$MyVariable</strong> will be processed during discovery. So will the name of the It block. The test itself will fail, because the <strong>$MyVariable</strong> has not been set inside either BeforeAll or It.</p>
<p>When discovery is completed, you could say that the remaining script to run for the Run phase would be the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="n">Describe</span> <span class="s1">&#39;Discovery example&#39;</span> <span class="p">{</span>
    <span class="n">Context</span> <span class="s1">&#39;Some tests&#39;</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="nv">$ExpectedResult</span> <span class="p">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="p">}</span>
        <span class="n">It</span> <span class="s2">&#34;true is true&#34;</span> <span class="p">{</span>
            <span class="s1">&#39;true&#39;</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$ExpectedResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="will-this-execute-in-discovery-or-run">Will this execute in Discovery or Run?</h2>
<p>The following example shows what parts of a test script runs during the Discovery versus the Run phase.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Discovery</span>
<span class="n">BeforeAll</span> <span class="p">{</span>
    <span class="c"># Run</span>
<span class="p">}</span>
<span class="n">Describe</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
    <span class="c"># Discovery</span>
    <span class="n">BeforeAll</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">BeforeEach</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">Context</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
        <span class="n">BeforeAll</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">BeforeEach</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="c"># Discovery</span>
        <span class="n">It</span> <span class="s2">&#34;Discovery&#34;</span> <span class="n">-Tag</span> <span class="s1">&#39;Discovery&#39;</span> <span class="n">-TestCases</span> <span class="p">@{</span><span class="s1">&#39;Discovery&#39;</span> <span class="p">=</span> <span class="s1">&#39;Discovery&#39;</span><span class="p">}</span> <span class="n">-Skip</span><span class="err">:</span><span class="nv">$Discovery</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">AfterEach</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
        <span class="n">AfterAll</span> <span class="p">{</span>
            <span class="c"># Run</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">AfterEach</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
    <span class="n">AfterAll</span> <span class="p">{</span>
        <span class="c"># Run</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">AfterAll</span> <span class="p">{</span>
    <span class="c"># Run</span>
<span class="p">}</span>
<span class="c"># Discovery</span>
</code></pre></div><h2 id="generating-tests-with-testcases">Generating tests with TestCases</h2>
<p>If you want to dynamically generate tests in your scripts you have to write the script a bit different compared to Pester 4. Previously we could generate tests like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Pester 4</span>
<span class="n">Describe</span> <span class="s1">&#39;Pester 4 Example&#39;</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$number</span> <span class="k">in</span> <span class="n">1</span><span class="p">..</span><span class="n">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">It</span> <span class="s2">&#34;$number is a number&#34;</span> <span class="p">{</span>
            <span class="nv">$number</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeOfType</span> <span class="no">[int]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This would generate 10 tests in Pester 4 and everything would work. But in Pester 5 this would not work since we now have the discovery phase and the <strong>$number</strong> parameter would not be available inside the It block during the Test phase. Instead you can use the TestCases parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="c"># Pester 5</span>
<span class="n">Describe</span> <span class="s1">&#39;Pester 5 Example&#39;</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$number</span> <span class="k">in</span> <span class="n">1</span><span class="p">..</span><span class="n">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">It</span> <span class="s2">&#34;$number is a number&#34;</span> <span class="n">-TestCases</span> <span class="p">@{</span><span class="s1">&#39;digit&#39;</span> <span class="p">=</span> <span class="nv">$number</span><span class="p">}</span> <span class="p">{</span>
            <span class="nv">$digit</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-BeOfType</span> <span class="no">[int]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>The reason for this is that <strong>all the parameters for the It command is evaluated in Discovery, except the script block</strong>. The foreach loop is located directly in the Describe block which means that it will be processed during Discovery as well.</p>
<h2 id="how-testcases-work">How TestCases work</h2>
<p>Notice that the variable <strong>$digit</strong> just magically appeared in the script block for It in the last example? Let me try to explain what happened there.</p>
<p>The TestCases parameter accepts a hash table. When the script block executes Pester will create variables for each key in the hash table. The following example shows how two variables are created from the TestCases parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="nv">$tests</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="s1">&#39;First&#39;</span>  <span class="p">=</span> <span class="s1">&#39;word&#39;</span>
    <span class="s1">&#39;Second&#39;</span> <span class="p">=</span> <span class="s1">&#39;word&#39;</span>
<span class="p">}</span>

<span class="n">It</span> <span class="s2">&#34;first and second is the same&#34;</span> <span class="n">-TestCases</span> <span class="nv">$tests</span> <span class="p">{</span>
    <span class="nv">$First</span> <span class="p">|</span> <span class="n">Should</span> <span class="n">-Be</span> <span class="nv">$Second</span>
<span class="p">}</span>
</code></pre></div><p>Understanding discovery is a major part of understanding Pester 5. I hope this post has helped answer a few questions.</p>


                
                    <div class="disqus-section">
                        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-roostech-se" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                    </div>
                
            </div>

       </div>
    


            </div>
        </div>
    </body>
</html>
